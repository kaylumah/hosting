<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <link rel="icon" href="/assets/images/favicon.ico" />
        <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/apple-touch-icon.png" />
        <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon-32x32.png" />
        <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon-16x16.png" />
        <link rel="manifest" href="/assets/images/site.webmanifest" />
        <link rel="mask-icon" href="/assets/images/safari-pinned-tab.svg" color="DarkGreen" />
        
        <link href="/compiled.css?v=17adcf4" rel="stylesheet" />
        <!-- <link href="/assets/prism.css?v=17adcf4" rel="stylesheet" /> -->
        
        
        
        
        <!-- Begin Kaylumah SEO tag v17adcf4 -->
        
        <title>Capture Logs in Unit Tests</title>
        <link rel="canonical" href="https://kaylumah.nl/2021/11/14/capture-logs-in-unit-tests.html" />
        
        <meta name="generator" content="Kaylumah v17adcf4" />
        <meta name="description" content="A guide to capturing logs in Xunit">
        <!-- <meta name="keywords" content="csharp,testing,xunit"> -->
        <meta name="author" content="Max Hamuly√°k">
        <meta name="copyright" content="¬© Kaylumah. All rights reserved.">
        
        <meta property="og:locale" content="en" />
        <meta property="og:site_name" content="Max Hamuly√°k ¬∑ Kaylumah" />
        <meta property="og:type" content="article" />
        <meta property="og:title" content="Capture Logs in Unit Tests">
        <meta property="og:url" content="https://kaylumah.nl/2021/11/14/capture-logs-in-unit-tests.html">
        <meta property="og:image" content="https://kaylumah.nl/assets/images/posts/20211114/capture-logs-in-unit-tests/cover_image.png">
        <meta property="og:description" content="A guide to capturing logs in Xunit"><meta property="article:author" content="Max Hamuly√°k">
        <meta property="article:published_time" content="2021-11-14T20:30:00.0000000+00:00">
        <meta property="article:modified_time" content="2021-11-14T20:30:00.0000000+00:00">
        
        <meta property="article:tag" content="csharp" />
        
        <meta property="article:tag" content="testing" />
        
        <meta property="article:tag" content="xunit" />
        
        
        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:title" content="Capture Logs in Unit Tests">
        <meta name="twitter:site" content="@kaylumah">
        <meta name="twitter:creator" content="@kaylumah" />
        <meta name="twitter:description" content="A guide to capturing logs in Xunit">
        <meta name="twitter:image" content="https://kaylumah.nl/assets/images/posts/20211114/capture-logs-in-unit-tests/cover_image.png">
        
        <script type="application/ld+json">
        {
          "@context": "https://schema.org",
          "@type": "BlogPosting",
          "image": "https://kaylumah.nl/assets/images/posts/20211114/capture-logs-in-unit-tests/cover_image.png",
          "mainEntityOfPage": "https://kaylumah.nl/2021/11/14/capture-logs-in-unit-tests.html",
          "author": {
            "@context": "https://schema.org",
            "@type": "Person",
            "name": "Max Hamuly√°k",
            "url": "https://kaylumah.nl"
          },
          "dateModified": "2021-11-14",
          "datePublished": "2021-11-14",
          "headline": "Capture Logs in Unit Tests"
        }
        </script>
        
        <!-- End Kaylumah SEO tag -->
        <!-- BEGIN Feed MetaData-->
        <link
          type="application/atom+xml"
          rel="alternate"
          href="https://kaylumah.nl/feed.xml"
          title="Max Hamuly√°k ¬∑ Kaylumah RSS Feed"
        />
        <!-- END Feed MetaData -->

        <!--
                                                           
          _  __           _                       _        
         | |/ /__ _ _   _| |_   _ _ __ ___   __ _| |__     
         | ' // _` | | | | | | | | '_ ` _ \ / _` | '_ \    
         | . \ (_| | |_| | | |_| | | | | | | (_| | | | |   
         |_|\_\__,_|\__, |_|\__,_|_| |_| |_|\__,_|_| |_|   
                    |___/                                  
                                                           
         ¬© Kaylumah. All rights reserved.                             
         17adcf47e46bae23c41a61b02c065888100263db                              
         2.1.3                               
         06/04/2022 17:28:34 +00:00
         site: 5779c7fd-cd79-5890-b41c-18d7868b3777
         page: 67eda832-3137-5b0c-9496-08aa27258ca5                                  
                                                           
         You found üß∏                                      
                                                           
                                                           
        -->
        
        <script>
        
          const consoleSignatureText = '%cüë®‚Äçüíª Thank you for your visit to my little spot on the internet, be welcome! üß∏';
          const consoleSignatureStyle = `
          font-size: 16px;
          background: #4cae50;
          color: white;
          text-align: center;
          padding: 10px 15px;
          width: 100%;
          border-radius: 20px;
        `;
          console.log(consoleSignatureText, consoleSignatureStyle);
        </script>
        
        <!-- Place your kit's code here -->
        <script data-search-pseudo-elements defer src="https://kit.fontawesome.com/61d3312dd9.js" crossorigin="anonymous"></script>
        
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-168549883-1"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
        
          gtag('config', 'UA-168549883-1');
        </script>

        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Architects+Daughter&family=Roboto&display=swap" />
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Architects+Daughter&family=Roboto&display=swap" media="print" onload="this.media='all'" />
        <noscript>
            <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Architects+Daughter&family=Roboto&display=swap" />
        </noscript>
    </head>
    <body class="line-numbers bg-gray-100 fa-colors">
        <div class="flex flex-col h-screen">
            <header class="bg-gray-900">
                <nav class="flex flex-wrap items-center justify-between py-4 px-4">
                    <div>
                        <a href="/" rel="author">
                            <!-- <img class="block md:hidden h-12 w-auto" src="/assets/logo_small.svg" alt="Kaylumah" /> -->
                            <img class="h-12 w-20" height="48" width="80" src="/assets/logo.svg" alt="Kaylumah" />
                        </a>
                    </div>
                    <div class="flex md:hidden">
                        <button id="hamburger" class="inline-flex items-center justify-center p-2 rounded-md text-gray-100 hover:text-gray-400 hover:bg-gray-500">
                            <span class="sr-only">Open main menu</span>
                            <svg class="toggle block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                            </svg>
                            <svg class="toggle hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div class="toggle hidden md:flex w-full md:w-auto text-right text-bold mt-5 md:mt-0 border-t-2 border-gray-600 md:border-none"><a href="/about.html" class="block md:inline-block text-gray-100 hover:text-gray-400 px-3 py-3 border-b-2 border-gray-600 md:border-none">
                            About
                        </a><a href="/blog.html" class="block md:inline-block text-gray-100 hover:text-gray-400 px-3 py-3 border-b-2 border-gray-600 md:border-none">
                            Blog
                        </a></div>
                </nav>
                 <script>
                    document.getElementById('hamburger').onclick = function toggleMenu() {
                    const navToggle = document.getElementsByClassName('toggle');
                        for (let i = 0; i < navToggle.length; i++) {
                            navToggle.item(i).classList.toggle('hidden');
                        }
                    };
                </script>
            </header>

            <main class="flex-1 py-4 text-gray-900">
                <article class="py-16 px-6 sm:px-8">
    <header>
        <h1 class="flex flex-col items-center mx-auto">
            <span class="text-gray-900 font-semibold tracking-wide uppercase">Article</span>
            <span class="mt-2 text-3xl font-extrabold tracking-tight text-gray-900 sm:text-4xl">Capture Logs in Unit Tests</span>
        </h1>
        <picture>
                        
                        <source type="image/webp" srcset="/assets/images/posts/20211114/capture-logs-in-unit-tests/cover_image.webp">
                        <img class="mx-auto mt-1" src="/assets/images/posts/20211114/capture-logs-in-unit-tests/cover_image.png" alt="cover for Capture Logs in Unit Tests" height="640" width="1280" />
                        
        </picture>
        <div class="mx-auto mt-1">
            <dl class="rounded-lg sm:grid sm:grid-cols-4">
                <div class="flex flex-col p-6 text-center">
                    <dt class="order-2 mt-2 text-lg leading-6 font-medium text-gray-800">
                        Authored by
                    </dt>
                    <dd class="order-1 text-xl font-extrabold">
                        Max Hamuly√°k
                    </dd>
                </div>
                <div class="flex flex-col p-6 text-center">
                    <dt class="order-2 mt-2 text-lg leading-6 font-medium text-gray-800">
                        Posted on
                    </dt>
                    <dd class="order-1 text-xl font-extrabold">
                        <time datetime="2021-11-14">2021/11/14</time>
                    </dd>
                </div>
                <div class="flex flex-col p-6 text-center">
                    <dt class="order-2 mt-2 text-lg leading-6 font-medium text-gray-800">
                        Reading time
                    </dt>
                    <dd class="order-1 text-xl font-extrabold">
                        7 minute
                    </dd>
                </div>
                <div class="flex flex-col p-6 text-center">
                    <dt class="order-2 mt-2 text-lg leading-6 font-medium text-gray-800">
                        Published in
                    </dt>
                    <dd class="order-1 text-xl font-extrabold">
                    
                                        <a href="/archive.html#csharp" title="for the C# programming language" class="text-gray-800">
                                            <!-- <span class="text-gray-600">#</span> -->
                                            C#
                                        </a>
                                        
                                        <a href="/archive.html#testing" title="for test related matters" class="text-gray-800">
                                            <!-- <span class="text-gray-600">#</span> -->
                                            Testing
                                        </a>
                                        
                                        <a href="/archive.html#xunit" title="for the Xunit test framework" class="text-gray-800">
                                            <!-- <span class="text-gray-600">#</span> -->
                                            Xunit
                                        </a>
                                        
                    </dd>
                </div>
            </dl>
        </div>
        
        <hr class="mt-8 border-t-2 w-20 mx-auto" />
    </header>
    <div class="mt-8 mx-auto max-w-prose md:max-w-7xl prose md:prose-lg lg:prose-xl">
        <p>In application code, we are used to writing log statements primarily for diagnostic purposes. For instance, we use logs to capture unexpected error flows. Therefore it is not uncommon to want to capture the log output in our unit tests. You have three distinctive options to handle log output in unit tests, as far as I can tell.</p>
<h2 id="scenario"><a href="#scenario">Scenario</a></h2>
<p>Our test scenario is a service or system under test (SUT) that takes a string input and returns it without modification. We rely on <code>Microsoft Extensions</code> for our logging purposes. As the test framework, we will be using <code>Xunit</code>.</p>
<pre><code class="language-cs">public interface IEchoService
{
    Task&lt;string&gt; Echo(string input);
}
</code></pre>
<p>The initial implementation of our SUT could look like this:</p>
<pre><code class="language-cs">public class EchoService : IEchoService
{
    private readonly ILogger&lt;EchoService&gt; _logger;

    public EchoService(ILogger&lt;EchoService&gt; logger)
    {
        _logger = logger;
    }

    public Task&lt;string&gt; Echo(string input)
    {
        _logger.LogInformation(&quot;echo was invoked&quot;);
        return Task.FromResult(input);
    }
}
</code></pre>
<p>For this article, the snippet above would be more than sufficient. But in a real-life application, I prefer to log the input as well. If, however, we would use simple string interpolation, we immediately get a Code-Analysis warning about it. The recommendation here is to use LoggerMessage that enables the use of <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/logging/loggermessage?view=aspnetcore-6.0" class="external">high-performance logging</a>. I've always found that implementing the LoggerMessage pattern required quite a bit of boilerplate. Luckily in .NET 6, this is a lot easier. We can <a href="https://docs.microsoft.com/en-us/dotnet/core/extensions/logger-message-generator" class="external">generate</a> all the boilerplate we need. As per usual, Andrew Lock <a href="https://andrewlock.net/exploring-dotnet-6-part-8-improving-logging-performance-with-source-generators/" class="external">wrote a piece</a> about this new feature already.</p>
<p>After applying our <code>LoggerMessage</code> changes to the SUT it looks like the snippet below. Please note that in order for this to work the class <code>EchoService</code> it self is now marked as <code>partial</code>.</p>
<pre><code class="language-cs">public partial class EchoService : IEchoService
{
    private readonly ILogger&lt;EchoService&gt; _logger;

    public EchoService(ILogger&lt;EchoService&gt; logger)
    {
        _logger = logger;
    }

    public Task&lt;string&gt; Echo(string input)
    {
        //_logger.LogInformation(&quot;echo was invoked&quot;);

        // The logging message template should not vary between calls to ... csharp(CA2254)
        // _logger.LogInformation($&quot;echo was invoked with {input}&quot;);

        LogEchoCall(input);

        return Task.FromResult(input);
    }

    [LoggerMessage(1000, LogLevel.Information, &quot;echo was invoked '{EchoInput}'&quot;)]
    partial void LogEchoCall(string echoInput);
}
</code></pre>
<h2 id="option-1"><a href="#option-1">Option 1</a></h2>
<p>First up is doing absolutely nothing. Yeah, you read that correctly. You might find it silly to start this piece with the first option being nothing, but doing nothing with log statements in your test code is perfectly fine. Heck, even doing nothing comes in two flavours.</p>
<p>If we use Dependency Injection in our test, we have access to &quot;AddLogging()&quot;. If we don't provide a logging provider, our code will run just fine. Otherwise, if you have already set up a logging provider or provided one explicitly, it will log to zero or more providers depending on your current configuration. For instance, you could use the ConsoleLoggerProvider to log to the console during the test. I often use the DI variant in my test since I am writing extension methods on IServiceCollection to write up my code anyway, so using the same extension method in test code simplifies matters.</p>
<pre><code class="language-cs">[Fact]
public async Task Test_DependencyInjection_EmptyLoggingBuilder()
{
    var configuration = new ConfigurationBuilder().Build();
    var serviceProvider = new ServiceCollection()
        .AddLogging() // could also be part of AddEcho to make sure ILogger is available outside ASP.NET runtime
        .AddEcho(configuration)
        .BuildServiceProvider();
    var sut = serviceProvider.GetRequiredService&lt;IEchoService&gt;();
    var testInput = &quot;Scenario: empty logging builder&quot;;
    var testResult = await sut.Echo(testInput).ConfigureAwait(false);
    testResult.Should().Be(testInput, &quot;the input should have been returned&quot;);
}
</code></pre>
<p><img src="/assets/images/posts/20211114/capture-logs-in-unit-tests/001_NoLogger.png" width="1564" height="814" alt="VS Code - Dotnet Debugger - No ILogger Registered" /></p>
<pre><code class="language-cs">[Fact]
public async Task Test_DependencyInjection_ConsoleLoggingBuilder()
{
    var configuration = new ConfigurationBuilder().Build();
    var serviceProvider = new ServiceCollection()
        .AddLogging(loggingBuilder =&gt; {
            loggingBuilder.AddConsole();
        })
        .AddEcho(configuration)
        .BuildServiceProvider();
    var sut = serviceProvider.GetRequiredService&lt;IEchoService&gt;();
    var testInput = &quot;Scenario: console logging builder&quot;;
    var testResult = await sut.Echo(testInput).ConfigureAwait(false);
    testResult.Should().Be(testInput, &quot;the input should have been returned&quot;);
}
</code></pre>
<p><img src="/assets/images/posts/20211114/capture-logs-in-unit-tests/002_ConsoleLogger.png" width="1564" height="814" alt="VS Code - Dotnet Debugger - console ILogger registered" /></p>
<p>If, however, you cannot rely on dependency injection in your tests, you have the alternative of manual creating your SUT and relevant dependencies. The only dependency of our EchoService is an instance of ILogger. For testing purposes, you can use the NullLoggerFactory, which creates a logger that logs into the void.</p>
<pre><code class="language-cs">[Fact]
public async Task Test_Manuel_NullLoggingFactory()
{
    var sut = new EchoService(NullLogger&lt;EchoService&gt;.Instance);
    var testInput = &quot;Scenario: null logger factory&quot;;
    var testResult = await sut.Echo(testInput).ConfigureAwait(false);
    testResult.Should().Be(testInput, &quot;the input should have been returned&quot;);
}
</code></pre>
<p><img src="/assets/images/posts/20211114/capture-logs-in-unit-tests/003_NullLogger.png" width="1564" height="814" alt="VS Code - Dotnet Debugger - null ILogger registered" /></p>
<blockquote>
<p>As you can see in the screenshot above, and empty logger and a NullLogger are not the same thing.</p>
</blockquote>
<h2 id="option-2"><a href="#option-2">Option 2</a></h2>
<p>The second method uses the Moq framework, which makes it possible to hide the logger behind a Mock, which means it's a fake version of ILogger. In my previous article, <a href="https://kaylumah.nl/2021/04/11/an-approach-to-writing-mocks.html">&quot;Adventures with Mock&quot;</a>, I touched upon my preferred method of writing mocks. I even included an initial version of the LoggerMock. Since then, I have fleshed out the concept more, so here is an updated version of the Logger Mock.</p>
<pre><code class="language-cs">public class LoggerMock&lt;TCategoryName&gt; : Mock&lt;ILogger&lt;TCategoryName&gt;&gt;
{
    private readonly List&lt;LogMessage&gt; logMessages = new();

    public ReadOnlyCollection&lt;LogMessage&gt; LogMessages =&gt; new(logMessages);

    protected LoggerMock()
    {
    }

    public static LoggerMock&lt;TCategoryName&gt; CreateDefault()
    {
        return new LoggerMock&lt;TCategoryName&gt;()
            .SetupLog()
            .SetupIsEnabled(LogLevel.Information);
    }

    public LoggerMock&lt;TCategoryName&gt; SetupIsEnabled(LogLevel logLevel, bool enabled = true)
    {
        Setup(x =&gt; x.IsEnabled(It.Is&lt;LogLevel&gt;(p =&gt; p.Equals(logLevel))))
            .Returns(enabled);
        return this;
    }

    public LoggerMock&lt;TCategoryName&gt; SetupLog()
    {
        Setup(logger =&gt; logger.Log(
            It.IsAny&lt;LogLevel&gt;(),
            It.IsAny&lt;EventId&gt;(),
            It.Is&lt;It.IsAnyType&gt;((v, t) =&gt; true),
            It.IsAny&lt;Exception&gt;(),
            It.Is&lt;Func&lt;It.IsAnyType, Exception?, string&gt;&gt;((v, t) =&gt; true)
        ))
        .Callback(new InvocationAction(invocation =&gt; {
            var logLevel = (LogLevel)invocation.Arguments[0];
            var eventId = (EventId)invocation.Arguments[1];
            var state = invocation.Arguments[2];
            var exception = (Exception?)invocation.Arguments[3];
            var formatter = invocation.Arguments[4];

            var invokeMethod = formatter.GetType().GetMethod(&quot;Invoke&quot;);
            var actualMessage = (string?)invokeMethod?.Invoke(formatter, new[] { state, exception });

            logMessages.Add(new LogMessage {
                EventId = eventId,
                LogLevel = logLevel,
                Message = actualMessage,
                Exception = exception,
                State = state
            });
        }));
        return this;
    }
}
</code></pre>
<p>Any <code>Mock</code> created with Moq will provide you with the ability to assert invocations made to the mocked class. Since my approach makes the mock stateful, I can capture any request made against it. We can make concrete assertions because we can access information like <code>EventId</code> and <code>LogLevel</code>. If, for instance, you have alerts written against business events, you want to validate that the correct information passes into your logging system.</p>
<pre><code class="language-cs">[Fact]
public async Task Test_Moq_DefaultMockedLogger()
{
    var loggerMock = LoggerMock&lt;EchoService&gt;.CreateDefault();
    var sut = new EchoService(loggerMock.Object);
    var testInput = &quot;Scenario: mocked logger&quot;;
    var testResult = await sut.Echo(testInput).ConfigureAwait(false);
    testResult.Should().Be(testInput, &quot;the input should have been returned&quot;);

    loggerMock.LogMessages.Should().NotBeEmpty().And.HaveCount(1);
    loggerMock.VerifyEventWasLogged(new EventId(1000));
}

[Fact]
public async Task Test_Moq_LogLevelDisabledMockedLogger()
{
    var loggerMock = LoggerMock&lt;EchoService&gt;.CreateDefault().SetupIsEnabled(LogLevel.Information, enabled: false);
    var sut = new EchoService(loggerMock.Object);
    var testInput = &quot;Scenario: log level disabled mocked logger&quot;;
    var testResult = await sut.Echo(testInput).ConfigureAwait(false);
    testResult.Should().Be(testInput, &quot;the input should have been returned&quot;);

    loggerMock.LogMessages.Should().BeEmpty();
}
</code></pre>
<p><img src="/assets/images/posts/20211114/capture-logs-in-unit-tests/004_MockLogger.png" width="1564" height="814" alt="VS Code - Dotnet Debugger - mock ILogger registered" /></p>
<h2 id="options-3"><a href="#options-3">Options 3</a></h2>
<p>Thus far, we have discussed options that would work outside <code>Xunit</code>. The third technique is not limited to <code>Xunit</code>, but its implementation is restricted to use in a <code>Xunit</code> project because we will now rely on Xunit's <code>ITestOutputHelper</code> mechanism. In most cases, we would use <code>ITestOutputHelper</code> to log lines inside the test case itself; it is, however, possible to create an <code>ILogger</code> that writes to <code>ITestOutputHelper</code> so we can also capture logs our SUT produces.</p>
<p>Microsoft has <a href="https://docs.microsoft.com/en-us/dotnet/core/extensions/custom-logging-provider" class="external">well-written documentation</a> on how to create a custom logger provider. We start with a configuration class for our <code>XunitLogger</code>. We will have no custom settings in this demo, but putting the configuration in place makes it easier to add settings later. The <code>ConsoleLogger</code>, for example, uses configuration to control LogScope inclusion and timestamp formats.</p>
<pre><code class="language-cs">public class XunitLoggerConfiguration
{
}
</code></pre>
<p>Next up is our Xunit logger itself. The ColoredConsole sample from the docs does nothing with scope, but to not limit ourselves later, we changed the implementation of <code>BeginScope</code> to use <code>IExternalScopeProvider</code>. To print the log line, we need the last argument of <code>Log&lt;TState&gt;</code>, which is the formatter. We then pass it the Xunit's ITestOutputHelper to <a href="https://xunit.net/docs/capturing-output" class="external">capture output</a>. Depending on your specific needs, you can log the logger's category (name), event, log level, scope or even exception. For now, let's keep it simple.</p>
<pre><code class="language-cs">public class XunitLogger : ILogger
{
    private readonly string _loggerName;
    private readonly Func&lt;XunitLoggerConfiguration&gt; _getCurrentConfig;
    private readonly IExternalScopeProvider _externalScopeProvider;
    private readonly ITestOutputHelper _testOutputHelper;

    public XunitLogger(string loggerName, Func&lt;XunitLoggerConfiguration&gt; getCurrentConfig, IExternalScopeProvider externalScopeProvider, ITestOutputHelper testOutputHelper)
    {
        _loggerName = loggerName;
        _getCurrentConfig = getCurrentConfig;
        _externalScopeProvider = externalScopeProvider;
        _testOutputHelper = testOutputHelper;
    }

    public IDisposable BeginScope&lt;TState&gt;(TState state) =&gt; _externalScopeProvider.Push(state);

    public bool IsEnabled(LogLevel logLevel) =&gt; LogLevel.None != logLevel;

    public void Log&lt;TState&gt;(LogLevel logLevel, EventId eventId, TState state, Exception? exception, Func&lt;TState, Exception?, string&gt; formatter)
    {
        if (!IsEnabled(logLevel))
        {
            return;
        }

         var message = formatter(state, exception);
         _testOutputHelper.WriteLine(message);
    }
}
</code></pre>
<p>An <code>ILoggerProvider</code> is responsible for creating <code>ILogger</code> instances; this means we also need the custom <code>XunitLoggerProvider</code> to take care of making our <code>XunitLogger</code>.</p>
<pre><code class="language-cs">public sealed class XunitLoggerProvider : ILoggerProvider
{
    private readonly IDisposable _configurationOnChangeToken;
    private XunitLoggerConfiguration _currentConfiguration;
    private readonly ConcurrentDictionary&lt;string, XunitLogger&gt; _loggers = new();
    private readonly IExternalScopeProvider _externalScopeProvider = new LoggerExternalScopeProvider();
    private readonly ITestOutputHelper _testOutputHelper;

    public XunitLoggerProvider(IOptionsMonitor&lt;XunitLoggerConfiguration&gt; optionsMonitor, ITestOutputHelper testOutputHelper)
    {
        _currentConfiguration = optionsMonitor.CurrentValue;
        _configurationOnChangeToken = optionsMonitor.OnChange(updatedConfiguration =&gt; _currentConfiguration = updatedConfiguration);
        _testOutputHelper = testOutputHelper;
    }

    public ILogger CreateLogger(string categoryName)
    {
        var logger = _loggers.GetOrAdd(categoryName, name =&gt; new XunitLogger(name, GetCurrentConfiguration, _externalScopeProvider, _testOutputHelper));
        return logger;
    }

    public void Dispose()
    {
        _loggers.Clear();
        _configurationOnChangeToken.Dispose();
    }

    private XunitLoggerConfiguration GetCurrentConfiguration() =&gt; _currentConfiguration;
}
</code></pre>
<p>The final puzzle piece is an extension method that allows us to register the new logger type. Note that we also add <code>ITestOutputHelper</code> to the DI container of the LoggingBuilder; that is why the <code>XunitLoggingProvider</code> in the previous snippet can retrieve it from the dependency injection container.</p>
<pre><code class="language-cs">public static class XunitLoggingBuilderExtensions
{
    public static ILoggingBuilder AddXunit(this ILoggingBuilder builder, ITestOutputHelper testOutputHelper)
    {
        builder.AddConfiguration();

        builder.Services.TryAddSingleton(testOutputHelper);

        builder.Services.TryAddEnumerable(
            ServiceDescriptor.Singleton&lt;ILoggerProvider, XunitLoggerProvider&gt;());

        LoggerProviderOptions.RegisterProviderOptions
            &lt;XunitLoggerConfiguration, XunitLoggerProvider&gt;(builder.Services);

        return builder;
    }

    public static ILoggingBuilder AddXunit(this ILoggingBuilder builder, ITestOutputHelper testOutputHelper, Action&lt;XunitLoggerConfiguration&gt; configure)
    {
        builder.AddXunit(testOutputHelper);
        builder.Services.Configure(configure);

        return builder;
    }
}
</code></pre>
<p>The usage is the same as the ConsoleLogger example we did previously.</p>
<pre><code class="language-cs">[Fact]
public async Task Test_Custom_XunitLoggingBuilder()
{
    var configuration = new ConfigurationBuilder().Build();
    var serviceProvider = new ServiceCollection()
        .AddLogging(loggingBuilder =&gt; {
            loggingBuilder.AddXunit(_testOutputHelper);
        })
        .AddEcho(configuration)
        .BuildServiceProvider();
    var sut = serviceProvider.GetRequiredService&lt;IEchoService&gt;();
    var testInput = &quot;Scenario: custom logging builder&quot;;
    var testResult = await sut.Echo(testInput).ConfigureAwait(false);
    testResult.Should().Be(testInput, &quot;the input should have been returned&quot;);
}
</code></pre>
<p><img src="/assets/images/posts/20211114/capture-logs-in-unit-tests/005_XunitLogger.png" width="1564" height="814" alt="VS Code - Dotnet Debugger - Xunit ILogger registered" /></p>
<p>The first time I ran this test, I was baffled. I could only see the console output from ConsoleLogger test we did previously. A quick google search brought me to the <a href="https://github.com/xunit/xunit/issues/1141#issuecomment-555717377" class="external">solution</a>. We need to tell the dotnet test runner to display it with <code>dotnet test --logger:&quot;console;verbosity=detailed&quot;</code>. Telling an entire team they can no longer simply run <code>dotnet test</code> was not a real solution; luckily, we can simplify things with <code>dotnet test --settings runsettings.xml</code>.</p>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;
&lt;RunSettings&gt;
    &lt;LoggerRunSettings&gt;
        &lt;Loggers&gt;
            &lt;Logger friendlyName=&quot;console&quot; enabled=&quot;True&quot;&gt;
                &lt;Configuration&gt;
                    &lt;Verbosity&gt;detailed&lt;/Verbosity&gt;
                &lt;/Configuration&gt;
            &lt;/Logger&gt;
        &lt;/Loggers&gt;
    &lt;/LoggerRunSettings&gt;
&lt;/RunSettings&gt;
</code></pre>
<p>However, explicitly passing <code>--settings</code> every time does not solve anything. On the <a href="https://docs.microsoft.com/en-us/visualstudio/test/configure-unit-tests-by-using-a-dot-runsettings-file?view=vs-2022" class="external">Microsoft Docs</a> I found the solution. We can tell MSBuild to use <code>RunSettingsFilePath</code>, which takes care of it for us. If we now run <code>dotnet test</code> we get proper output. For example, you can add a <code>Directory.Build.props</code> to the root of your project.</p>
<pre><code class="language-xml">&lt;Project&gt;
  &lt;PropertyGroup&gt;
    &lt;RunSettingsFilePath&gt;$(MSBuildThisFileDirectory)runsettings.xml&lt;/RunSettingsFilePath&gt;
  &lt;/PropertyGroup&gt;
&lt;/Project&gt;
</code></pre>
<h2 id="closing-thoughts"><a href="#closing-thoughts">Closing Thoughts</a></h2>
<p>I know I am not the first to write about this topic, but I hope to provide fresh insight into the subject matter. The different techniques all have their merit. I have used all three on other occasions and remind you that the NullLogger is a viable option in many cases. Nine times out of 10, you probably only care about the business logic to test. For the final remaining time, I can only say the well-known programming wisdom: &quot;It depends&quot;.</p>
<p>As always, if you have any questions, feel free to reach out. Do you have suggestions or alternatives? I would love to hear about them.</p>
<p>The corresponding source code for this article is on <a href="https://github.com/kaylumah/CaptureLogsInUnitTests" class="external">GitHub</a>.</p>
<p>See you next time, stay healthy and happy coding to all üß∏!</p>
    </div>

    <footer class="flex flex-col mt-8">
        
                <div class="social-share">
            <span class="mx-auto">Enjoying my content? Consider sharing and help me grow my audience :)</span>
            <div class="flex justify-center space-x-6">
                    <a target="_blank" rel=‚Äùnoopener‚Äù title="Share link to post via LinkedIn" href="https://www.linkedin.com/shareArticle?mini=true&url=https://kaylumah.nl/2021/11/14/capture-logs-in-unit-tests.html" onclick="window.open(this.href, 'width=550,height=435');return false;">
                        <span class="sr-only">LinkedIn Share</span>
                        <em class="fab fa-linkedin fa-lg"></em>
                    </a>
                    <a target="_blank" rel=‚Äùnoopener‚Äù title="Share link to post via Twitter" href="https://twitter.com/intent/tweet?text=Capture%20Logs%20in%20Unit%20Tests&url=https://kaylumah.nl/2021/11/14/capture-logs-in-unit-tests.html" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                        <span class="sr-only">Twitter Share</span>
                        <em class="fab fa-twitter-square fa-lg"></em>
                    </a>
                    <a target="_blank" rel=‚Äùnoopener‚Äù title="Share link to post via Facebook" href="https://facebook.com/sharer.php?u=https://kaylumah.nl/2021/11/14/capture-logs-in-unit-tests.html" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;">
                        <span class="sr-only">Facebook Share</span>
                        <em class="fab fa-facebook fa-lg"></em>
                    </a>
                    <a target="_blank" rel=‚Äùnoopener‚Äù title="Share link to post via Email" href="mailto:?subject=Capture Logs in Unit Tests&amp;body=Thought you might like this article https://kaylumah.nl/2021/11/14/capture-logs-in-unit-tests.html">
                        <span class="sr-only">Email Share</span>
                        <em class="fas fa-envelope-open-text fa-lg"></em>
                    </a>
            </div>
        </div>
                
        
                <script src="  https://unpkg.com/showdown/dist/showdown.min.js"></script>
        <script>
        const GH_ISSUE_API = 'https://api.github.com/repos/kaylumah/kaylumah.github.io/issues/50/comments?per_page=100';
        let request = new XMLHttpRequest();
        request.open( 'GET', GH_ISSUE_API, true );
        
        request.onload = function() {
            if ( this.status >= 200 && this.status < 400 ) { 
                let response = JSON.parse( this.response );
        
                for ( var i = 0; i < response.length; i++ ) {
        			document.getElementById( 'gh-comments-list' ).appendChild( createCommentEl( response[ i ] ) );
        		}
                document.getElementById( 'no-comments-found' ).style.display = 0 === response.length  ? 'block' : 'none';
            }
            else {
                console.error( this );
            }
        };
        
        function createCommentEl( response ) {
            let userName = document.createElement('h3');
            userName.classList.add('text-sm', 'font-medium');
            userName.innerHTML = `@${response.user.login}`;
        
            let commentTime = document.createElement('p');
            commentTime.classList.add('text-sm', 'text-gray-700');
            commentTime.textContent = response.created_at;
        
            let commentMetadata = document.createElement('div');
            commentMetadata.classList.add('flex', 'items-center', 'justify-between');
            commentMetadata.appendChild(userName);
            commentMetadata.appendChild(commentTime);
        
            let commentContents = document.createElement('p');
            commentContents.classList.add('mx-auto', 'prose', 'md:prose-lg', 'lg:prose-xl');
            commentContents.innerHTML = response.body;
            // Progressive enhancement.
        	if ( window.showdown ) {
        		let converter = new showdown.Converter();
        		commentContents.innerHTML = converter.makeHtml( response.body );
        	}
        
            let commentWrapper = document.createElement('div');
            commentWrapper.classList.add('flex-1', 'space-y-1');
            commentWrapper.appendChild(commentMetadata);
            commentWrapper.appendChild(commentContents);
        
            let userAvatar = document.createElement( 'img' );
            userAvatar.classList.add('h-8', 'w-8');
        	userAvatar.setAttribute( 'src', response.user.avatar_url );
            userAvatar.setAttribute( 'alt', `${response.user.login} GitHub Avatar` );
            userAvatar.setAttribute( 'width', 32 );
            userAvatar.setAttribute( 'height', 32 );
        
            let commentLink = document.createElement('a');
            commentLink.classList.add('flex', 'space-x-3');
            commentLink.appendChild(userAvatar);
            commentLink.appendChild(commentWrapper);
            commentLink.setAttribute( 'href', response.html_url );
        
            let comment = document.createElement('li');
            comment.classList.add('py-4');
            comment.setAttribute( 'data-created', response.created_at );
        	comment.setAttribute( 'data-author-avatar', response.user.avatar_url );
        	comment.setAttribute( 'data-user-url', response.user.url );
            comment.appendChild(commentLink);
        
            return comment;
        }
        
        request.send();
        </script>
        
        <div class="github-comments" class="mt-2">
        	<h2>Comments</h2>
        	<ul class="divide-y divide-gray-200" id="gh-comments-list">
                <noscript>Please enable JavaScript to load the comments.</noscript>
                <li id="no-comments-found" class="py-4">
                    <span class="text-sm font-semibold">No comments found for this article.</span>
                </li>
            </ul>
        	<p id="leave-a-comment">Join the discussion for this article on <a class="font-semibold external" href="https://github.com/kaylumah/kaylumah.github.io/issues/50">this ticket</a>.</p>
        </div>
                
    </footer>
   
</article>
                <button class="fixed z-50 bottom-4 right-4 w-16 h-16 rounded-full bg-gray-300 text-white block" onclick="topFunction()" id="myBtn" title="Go to top">
                    <span class="sr-only">Back to top!</span>
                    <em class="fad fa-angle-double-up fa-lg"></em>
                </button>
                <script>
                    var mybutton = document.getElementById("myBtn");
                
                    window.onscroll = function() {scrollFunction()};
                
                    function scrollFunction() {
                        if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                            mybutton.style.display = "block";
                        }
                        else {
                            mybutton.style.display = "none";
                        }
                    }
                    function topFunction() {
                        document.body.scrollTop = 0;
                        document.documentElement.scrollTop = 0;
                    }
                </script>
            </main>
            <footer class="bg-gray-900">
                <div class="py-4 px-4">
                    <div class="flex justify-center space-x-6">
                        
                        <a target="_blank" rel=‚Äùnoopener‚Äù href="https://www.linkedin.com/in/maxhamulyak" class="text-gray-100 hover:text-gray-400">
                            <span class="sr-only">LinkedIn</span>
                            <em class="fab fa-linkedin fa-lg"></em>
                        </a>
                        <a target="_blank" rel=‚Äùnoopener‚Äù href="https://github.com/kaylumah" class="text-gray-100 hover:text-gray-400">
                            <span class="sr-only">GitHub</span>
                            <em class="fab fa-github-square fa-lg"></em>
                        </a>
                        <a target="_blank" rel=‚Äùnoopener‚Äù href="https://twitter.com/kaylumah" class="text-gray-100 hover:text-gray-400">
                            <span class="sr-only">Twitter</span>
                            <em class="fab fa-twitter-square fa-lg"></em>
                        </a>
                    </div>
                    <div class="pt-2 flex flex-col text-center text-gray-100">
                        <span>¬© Kaylumah. All rights reserved.</span>
                        <span class="text-xs">Deployed from commit <a class="hover:text-gray-400" href="https://github.com/kaylumah/kaylumah.github.io/commit/17adcf47e46bae23c41a61b02c065888100263db">17adcf4</a> via build <a class="hover:text-gray-400" href="https://github.com/kaylumah/kaylumah.github.io/actions/runs/1">20220604.052732</a></span>
                    </div>
                    <div class="pt-2 flex justify-center space-x-6">
                        <a href="/" class="text-gray-100 hover:text-gray-400">
                            <span class="sr-only">Kaylumah</span>
                            <em class="fak fa-logo-kaylumah fa-lg"></em>
                        </a>
                    </div>
                </div>
            </footer>
        </div>
        <!-- <script src="/assets/prism.js?v=17adcf4"></script> -->
        
    </body>
</html>