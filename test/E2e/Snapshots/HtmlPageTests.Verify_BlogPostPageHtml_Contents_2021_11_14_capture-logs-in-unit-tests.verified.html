<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="icon" href="/assets/images/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon-16x16.png" />
    <link rel="manifest" href="/assets/images/site.webmanifest" />
    <link rel="mask-icon" href="/assets/images/safari-pinned-tab.svg" color="DarkGreen" />

    <link href="/compiled.css?v=[SHORT-COMMIT-HASH]" rel="stylesheet" />

    <!-- Begin Kaylumah SEO tag v[SHORT-COMMIT-HASH] -->
    
    <!-- Common Meta Tags -->
    <title>Capture Logs in Unit Tests</title>
    <link rel="canonical" href="https://BaseUrl_1/blog/2021/11/14/capture-logs-in-unit-tests.html" />
    <link rel="alternate" type="application/atom+xml" href="https://BaseUrl_1/feed.xml" title="Max Hamulyák · Kaylumah RSS Feed" />
    <link rel="sitemap" type="application/xml" href="https://BaseUrl_1/sitemap.xml" title="Max Hamulyák · Kaylumah Sitemap" />
    <meta name="generator" content="Kaylumah v[SHORT-COMMIT-HASH]" />
    <meta name="description" content="A guide to capturing logs in Xunit" />
    <meta name="copyright" content="© Kaylumah. All rights reserved." />
    <meta name="keywords" content="csharp, testing, xunit" />
    
    <!-- OpenGraph Meta Tags -->
    <meta property="og:type" content="article" />
    <meta property="og:locale" content="en" />
    <meta property="og:site_name" content="Max Hamulyák · Kaylumah" />
    <meta property="og:title" content="Capture Logs in Unit Tests" />
    <meta property="og:url" content="https://BaseUrl_1/blog/2021/11/14/capture-logs-in-unit-tests.html" />
    <meta property="og:description" content="A guide to capturing logs in Xunit" />
    <meta property="og:image" content="https://BaseUrl_1/assets/images/posts/20211114/capture-logs-in-unit-tests/cover_image.png" />
    <meta property="article:author" content="Max Hamulyák" />
    <meta property="article:published_time" content="2021-11-14T20:30:00.0000000+01:00" />
    <meta property="article:modified_time" content="2021-11-14T20:30:00.0000000+01:00" />
    <meta property="article:tag" content="csharp" />
    <meta property="article:tag" content="testing" />
    <meta property="article:tag" content="xunit" />
    
    <!-- Twitter Meta Tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Capture Logs in Unit Tests" />
    <meta name="twitter:description" content="A guide to capturing logs in Xunit" />
    <meta name="twitter:image" content="https://BaseUrl_1/assets/images/posts/20211114/capture-logs-in-unit-tests/cover_image.png" />
    <meta name="twitter:site" content="@kaylumah" />
    <meta name="twitter:creator" content="@kaylumah" />
    
    <!-- Kaylumah BuildInfo Meta Tags -->
    <meta property="kaylumah:copyright" content="© Kaylumah. All rights reserved." />
    <meta property="kaylumah:commit" content="[COMMIT-HASH]" />
    <meta property="kaylumah:version" content="1.0.0.BuildNumber_1" />
    <meta property="kaylumah:buildId" content="[BUILD-ID]" />
    <meta property="kaylumah:buildNumber" content="BuildNumber_1" />
    <meta property="kaylumah:time" content="DateTimeOffset_1" />
    <meta property="kaylumah:site" content="Guid_1" />
    <meta property="kaylumah:page" content="Guid_2" />
    
    <!-- LdJson Meta Tags -->
    <script type="application/ld+json">{
      "@context": "https://schema.org",
      "@type": "BlogPosting",
      "description": "A guide to capturing logs in Xunit",
      "image": "https://BaseUrl_1/assets/images/posts/20211114/capture-logs-in-unit-tests/cover_image.png",
      "mainEntityOfPage": "https://BaseUrl_1/blog/2021/11/14/capture-logs-in-unit-tests.html",
      "url": "https://BaseUrl_1/blog/2021/11/14/capture-logs-in-unit-tests.html",
      "author": {
        "@context": "https://schema.org",
        "@type": "Person",
        "name": "Max Hamulyák",
        "image": "https://BaseUrl_1/assets/avatar_background.svg",
        "sameAs": [
          "https://www.linkedin.com/in/maxhamulyak",
          "https://twitter.com/kaylumah"
        ],
        "email": "max@kaylumah.nl"
      },
      "dateModified": "2021-11-14T20:30:00+01:00",
      "datePublished": "2021-11-14T20:30:00+01:00",
      "headline": "Capture Logs in Unit Tests",
      "inLanguage": "en",
      "keywords": "csharp,testing,xunit",
      "publisher": {
        "@context": "https://schema.org",
        "@type": "Organization",
        "name": "kaylumah",
        "sameAs": "https://www.linkedin.com/company/kaylumah",
        "foundingDate": "2020-01-01",
        "logo": "https://BaseUrl_1/assets/logo.svg"
      },
      "timeRequired": "PT7M",
      "wordCount": 1631
    }</script>
    
    <!-- End Kaylumah SEO tag -->
    <!--
                                                        
       _  __           _                       _        
      | |/ /__ _ _   _| |_   _ _ __ ___   __ _| |__     
      | ' // _` | | | | | | | | '_ ` _ \ / _` | '_ \    
      | . \ (_| | |_| | | |_| | | | | | | (_| | | | |   
      |_|\_\__,_|\__, |_|\__,_|_| |_| |_|\__,_|_| |_|   
                 |___/                                  
                                                        
     You found 🧸                                      
                                                       
    -->
    
    <script>
    
      const consoleSignatureText = '%c👨‍💻 Thank you for your visit to my little spot on the internet, be welcome! 🧸';
      const consoleSignatureStyle = `
      font-size: 16px;
      background: #4cae50;
      color: white;
      text-align: center;
      padding: 10px 15px;
      width: 100%;
      border-radius: 20px;
    `;
      console.log(consoleSignatureText, consoleSignatureStyle);
    </script>
    <script>
      window.getCookieConsent = function() {
          try {
              const consent = document.cookie.match(/cookie-consent=([^;]+)/)[1];
              return consent;
          } catch (error) {
              console.log("failed to retrieve consent", error);
              return "unknown";
          }
      };
    
      window.setCookieConsent = function(status) {
    
        if (status != "denied" && status != "granted") {
          throw new Error(`Status ${status} is not supported!`);
        }
    
        let today = new Date();
        let expiryDate = new Date(today.getFullYear() + 1, today.getMonth(), today.getDate());
        document.cookie = `cookie-consent=${status}; expires=${expiryDate}; path=/`;
      }
    
    </script>
    <script>
      // Define dataLayer and the gtag function.
      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
    
      window.setGtagConsentStatus = function(mode, status) {
    
        if (mode != "update" && mode != "default") {
          throw new Error(`Mode ${mode} is not supported!`);
        }
    
        if (status != "denied" && status != "granted") {
          throw new Error(`Status ${status} is not supported!`);
        }
    
        gtag('consent', mode, {
          'ad_storage': status,
          'ad_user_data': status,
          'ad_personalization': status,
          'analytics_storage': status
        });
      }
    
      let currentStatus = window.getCookieConsent();
      let cookiesAllowed = currentStatus == "granted";
    
      if (cookiesAllowed) {
        console.log("cookies already approved");
        window.setGtagConsentStatus("default", "granted");
      } else {
        console.log("assume cookies are denied");
        window.setGtagConsentStatus("default", "denied");
      }
    </script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MEQZVWN0D7">
    </script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
    
      gtag('js', new Date());
      gtag('config', 'G-MEQZVWN0D7');
    </script>
    <link href="https://mastodon.nl/@kaylumah" rel="me">
</head>

<body class="bg-gray-100 antialiased">
    <div class="flex flex-col h-screen">
        <header class="bg-gray-900">
            <nav class="flex flex-wrap items-center justify-between p-4">
                <a data-testid="NavLink-Home" href="/" rel="home">
                    <img data-testid="NavLogo" class="h-12 w-20" height="48" width="80"
                        src="/assets/logo.svg" alt="Kaylumah" />
                </a>
                <button id="hamburger"
                    class="tablet:hidden p-2 rounded-md text-gray-100 hover:text-gray-400 hover:bg-gray-500">
                    <span class="sr-only">Open main menu</span>
                    <svg class="toggle block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                    <svg class="toggle hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <ul
                    class="toggle hidden tablet:flex w-full tablet:w-auto text-right text-bold mt-5 tablet:mt-0 border-t-2 border-gray-600 tablet:border-none">
                    
                                        <li>
                                            <a data-testid="NavLink-About" href="/about.html"
                                                class="block tablet:inline-block text-gray-100 hover:text-gray-400 px-3 py-3 border-b-2 border-gray-600 tablet:border-none">
                                                About
                                            </a>
                                        </li>
                                        
                                        <li>
                                            <a data-testid="NavLink-Blog" href="/blog.html"
                                                class="block tablet:inline-block text-gray-100 hover:text-gray-400 px-3 py-3 border-b-2 border-gray-600 tablet:border-none">
                                                Blog
                                            </a>
                                        </li>
                                        
                </ul>
            </nav>
            <script>
                document.getElementById('hamburger').onclick = function toggleMenu() {
                    const navToggle = document.getElementsByClassName('toggle');
                    for (let i = 0; i < navToggle.length; i++) {
                        navToggle.item(i).classList.toggle('hidden');
                    }
                };
            </script>
        </header>
        <main class="flex-1 p-4 text-gray-900">
            <div class="flex flex-col gap-8 laptop:flex-row">
    <article id="blogContents" class="flex-1 bg-slate-50 border-2 p-6 flex flex-col gap-8">
        <header class="prose laptop:mx-auto">
            <picture class="hidden">
                <source type="image/webp" srcset="/assets/images/posts/20211114/capture-logs-in-unit-tests/cover_image.png.webp">
                <img loading="lazy" src="/assets/images/posts/20211114/capture-logs-in-unit-tests/cover_image.png" alt="cover for Capture Logs in Unit Tests" height="640" width="1280" />
            </picture>
            <h1>Capture Logs in Unit Tests</h1>
            <div class="flex flex-row gap-4">
                <time datetime="2021-11-14">2021/11/14</time>
                <span>Max Hamulyák</span>
                <span>7 minute</span>
            </div>
            <span class="flex flex-row gap-4">
                
                                <a href="/blog.html?tag=csharp" title="for the C# programming language">C#</a>
                                
                                <a href="/blog.html?tag=testing" title="for test related matters">Testing</a>
                                
                                <a href="/blog.html?tag=xunit" title="for the Xunit test framework">Xunit</a>
                                
            </span>
        </header>
        <main class="prose laptop:mx-auto">
            <p>In application code, we are used to writing log statements primarily for diagnostic purposes. For instance, we use logs to capture unexpected error flows. Therefore it is not uncommon to want to capture the log output in our unit tests. You have three distinctive options to handle log output in unit tests, as far as I can tell.</p>
<h2 id="scenario"><a href="#scenario">Scenario</a></h2>
<p>Our test scenario is a service or system under test (SUT) that takes a string input and returns it without modification. We rely on <code>Microsoft Extensions</code> for our logging purposes. As the test framework, we will be using <code>Xunit</code>.</p>
<pre><code class="language-cs">public interface IEchoService
{
    Task&lt;string&gt; Echo(string input);
}
</code></pre>
<p>The initial implementation of our SUT could look like this:</p>
<pre><code class="language-cs">public class EchoService : IEchoService
{
    private readonly ILogger&lt;EchoService&gt; _logger;

    public EchoService(ILogger&lt;EchoService&gt; logger)
    {
        _logger = logger;
    }

    public Task&lt;string&gt; Echo(string input)
    {
        _logger.LogInformation(&quot;echo was invoked&quot;);
        return Task.FromResult(input);
    }
}
</code></pre>
<p>For this article, the snippet above would be more than sufficient. But in a real-life application, I prefer to log the input as well. If, however, we would use simple string interpolation, we immediately get a Code-Analysis warning about it. The recommendation here is to use LoggerMessage that enables the use of <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/logging/loggermessage?view=aspnetcore-6.0" class="external">high-performance logging</a>. I've always found that implementing the LoggerMessage pattern required quite a bit of boilerplate. Luckily in .NET 6, this is a lot easier. We can <a href="https://docs.microsoft.com/en-us/dotnet/core/extensions/logger-message-generator" class="external">generate</a> all the boilerplate we need. As per usual, Andrew Lock <a href="https://andrewlock.net/exploring-dotnet-6-part-8-improving-logging-performance-with-source-generators/" class="external">wrote a piece</a> about this new feature already.</p>
<p>After applying our <code>LoggerMessage</code> changes to the SUT it looks like the snippet below. Please note that in order for this to work the class <code>EchoService</code> it self is now marked as <code>partial</code>.</p>
<pre><code class="language-cs">public partial class EchoService : IEchoService
{
    private readonly ILogger&lt;EchoService&gt; _logger;

    public EchoService(ILogger&lt;EchoService&gt; logger)
    {
        _logger = logger;
    }

    public Task&lt;string&gt; Echo(string input)
    {
        //_logger.LogInformation(&quot;echo was invoked&quot;);

        // The logging message template should not vary between calls to ... csharp(CA2254)
        // _logger.LogInformation($&quot;echo was invoked with {input}&quot;);

        LogEchoCall(input);

        return Task.FromResult(input);
    }

    [LoggerMessage(1000, LogLevel.Information, &quot;echo was invoked '{EchoInput}'&quot;)]
    partial void LogEchoCall(string echoInput);
}
</code></pre>
<h2 id="option-1"><a href="#option-1">Option 1</a></h2>
<p>First up is doing absolutely nothing. Yeah, you read that correctly. You might find it silly to start this piece with the first option being nothing, but doing nothing with log statements in your test code is perfectly fine. Heck, even doing nothing comes in two flavours.</p>
<p>If we use Dependency Injection in our test, we have access to &quot;AddLogging()&quot;. If we don't provide a logging provider, our code will run just fine. Otherwise, if you have already set up a logging provider or provided one explicitly, it will log to zero or more providers depending on your current configuration. For instance, you could use the ConsoleLoggerProvider to log to the console during the test. I often use the DI variant in my test since I am writing extension methods on IServiceCollection to write up my code anyway, so using the same extension method in test code simplifies matters.</p>
<pre><code class="language-cs">[Fact]
public async Task Test_DependencyInjection_EmptyLoggingBuilder()
{
    var configuration = new ConfigurationBuilder().Build();
    var serviceProvider = new ServiceCollection()
        .AddLogging() // could also be part of AddEcho to make sure ILogger is available outside ASP.NET runtime
        .AddEcho(configuration)
        .BuildServiceProvider();
    var sut = serviceProvider.GetRequiredService&lt;IEchoService&gt;();
    var testInput = &quot;Scenario: empty logging builder&quot;;
    var testResult = await sut.Echo(testInput).ConfigureAwait(false);
    testResult.Should().Be(testInput, &quot;the input should have been returned&quot;);
}
</code></pre>
<p><picture><source type="image/webp" srcset="https://BaseUrl_1/assets/images/posts/20211114/capture-logs-in-unit-tests/001_NoLogger.png.webp"><img loading="lazy" src="https://BaseUrl_1/assets/images/posts/20211114/capture-logs-in-unit-tests/001_NoLogger.png" width="1564" height="814" alt="VS Code - Dotnet Debugger - No ILogger Registered" /></picture></p>
<pre><code class="language-cs">[Fact]
public async Task Test_DependencyInjection_ConsoleLoggingBuilder()
{
    var configuration = new ConfigurationBuilder().Build();
    var serviceProvider = new ServiceCollection()
        .AddLogging(loggingBuilder =&gt; {
            loggingBuilder.AddConsole();
        })
        .AddEcho(configuration)
        .BuildServiceProvider();
    var sut = serviceProvider.GetRequiredService&lt;IEchoService&gt;();
    var testInput = &quot;Scenario: console logging builder&quot;;
    var testResult = await sut.Echo(testInput).ConfigureAwait(false);
    testResult.Should().Be(testInput, &quot;the input should have been returned&quot;);
}
</code></pre>
<p><picture><source type="image/webp" srcset="https://BaseUrl_1/assets/images/posts/20211114/capture-logs-in-unit-tests/002_ConsoleLogger.png.webp"><img loading="lazy" src="https://BaseUrl_1/assets/images/posts/20211114/capture-logs-in-unit-tests/002_ConsoleLogger.png" width="1564" height="814" alt="VS Code - Dotnet Debugger - console ILogger registered" /></picture></p>
<p>If, however, you cannot rely on dependency injection in your tests, you have the alternative of manual creating your SUT and relevant dependencies. The only dependency of our EchoService is an instance of ILogger. For testing purposes, you can use the NullLoggerFactory, which creates a logger that logs into the void.</p>
<pre><code class="language-cs">[Fact]
public async Task Test_Manuel_NullLoggingFactory()
{
    var sut = new EchoService(NullLogger&lt;EchoService&gt;.Instance);
    var testInput = &quot;Scenario: null logger factory&quot;;
    var testResult = await sut.Echo(testInput).ConfigureAwait(false);
    testResult.Should().Be(testInput, &quot;the input should have been returned&quot;);
}
</code></pre>
<p><picture><source type="image/webp" srcset="https://BaseUrl_1/assets/images/posts/20211114/capture-logs-in-unit-tests/003_NullLogger.png.webp"><img loading="lazy" src="https://BaseUrl_1/assets/images/posts/20211114/capture-logs-in-unit-tests/003_NullLogger.png" width="1564" height="814" alt="VS Code - Dotnet Debugger - null ILogger registered" /></picture></p>
<blockquote>
<p>As you can see in the screenshot above, and empty logger and a NullLogger are not the same thing.</p>
</blockquote>
<h2 id="option-2"><a href="#option-2">Option 2</a></h2>
<p>The second method uses the Moq framework, which makes it possible to hide the logger behind a Mock, which means it's a fake version of ILogger. In my previous article, <a href="https://BaseUrl_1/blog/2021/04/11/an-approach-to-writing-mocks.html">&quot;Adventures with Mock&quot;</a>, I touched upon my preferred method of writing mocks. I even included an initial version of the LoggerMock. Since then, I have fleshed out the concept more, so here is an updated version of the Logger Mock.</p>
<pre><code class="language-cs">public class LoggerMock&lt;TCategoryName&gt; : Mock&lt;ILogger&lt;TCategoryName&gt;&gt;
{
    private readonly List&lt;LogMessage&gt; logMessages = new();

    public ReadOnlyCollection&lt;LogMessage&gt; LogMessages =&gt; new(logMessages);

    protected LoggerMock()
    {
    }

    public static LoggerMock&lt;TCategoryName&gt; CreateDefault()
    {
        return new LoggerMock&lt;TCategoryName&gt;()
            .SetupLog()
            .SetupIsEnabled(LogLevel.Information);
    }

    public LoggerMock&lt;TCategoryName&gt; SetupIsEnabled(LogLevel logLevel, bool enabled = true)
    {
        Setup(x =&gt; x.IsEnabled(It.Is&lt;LogLevel&gt;(p =&gt; p.Equals(logLevel))))
            .Returns(enabled);
        return this;
    }

    public LoggerMock&lt;TCategoryName&gt; SetupLog()
    {
        Setup(logger =&gt; logger.Log(
            It.IsAny&lt;LogLevel&gt;(),
            It.IsAny&lt;EventId&gt;(),
            It.Is&lt;It.IsAnyType&gt;((v, t) =&gt; true),
            It.IsAny&lt;Exception&gt;(),
            It.Is&lt;Func&lt;It.IsAnyType, Exception?, string&gt;&gt;((v, t) =&gt; true)
        ))
        .Callback(new InvocationAction(invocation =&gt; {
            var logLevel = (LogLevel)invocation.Arguments[0];
            var eventId = (EventId)invocation.Arguments[1];
            var state = invocation.Arguments[2];
            var exception = (Exception?)invocation.Arguments[3];
            var formatter = invocation.Arguments[4];

            var invokeMethod = formatter.GetType().GetMethod(&quot;Invoke&quot;);
            var actualMessage = (string?)invokeMethod?.Invoke(formatter, new[] { state, exception });

            logMessages.Add(new LogMessage {
                EventId = eventId,
                LogLevel = logLevel,
                Message = actualMessage,
                Exception = exception,
                State = state
            });
        }));
        return this;
    }
}
</code></pre>
<p>Any <code>Mock</code> created with Moq will provide you with the ability to assert invocations made to the mocked class. Since my approach makes the mock stateful, I can capture any request made against it. We can make concrete assertions because we can access information like <code>EventId</code> and <code>LogLevel</code>. If, for instance, you have alerts written against business events, you want to validate that the correct information passes into your logging system.</p>
<pre><code class="language-cs">[Fact]
public async Task Test_Moq_DefaultMockedLogger()
{
    var loggerMock = LoggerMock&lt;EchoService&gt;.CreateDefault();
    var sut = new EchoService(loggerMock.Object);
    var testInput = &quot;Scenario: mocked logger&quot;;
    var testResult = await sut.Echo(testInput).ConfigureAwait(false);
    testResult.Should().Be(testInput, &quot;the input should have been returned&quot;);

    loggerMock.LogMessages.Should().NotBeEmpty().And.HaveCount(1);
    loggerMock.VerifyEventWasLogged(new EventId(1000));
}

[Fact]
public async Task Test_Moq_LogLevelDisabledMockedLogger()
{
    var loggerMock = LoggerMock&lt;EchoService&gt;.CreateDefault().SetupIsEnabled(LogLevel.Information, enabled: false);
    var sut = new EchoService(loggerMock.Object);
    var testInput = &quot;Scenario: log level disabled mocked logger&quot;;
    var testResult = await sut.Echo(testInput).ConfigureAwait(false);
    testResult.Should().Be(testInput, &quot;the input should have been returned&quot;);

    loggerMock.LogMessages.Should().BeEmpty();
}
</code></pre>
<p><picture><source type="image/webp" srcset="https://BaseUrl_1/assets/images/posts/20211114/capture-logs-in-unit-tests/004_MockLogger.png.webp"><img loading="lazy" src="https://BaseUrl_1/assets/images/posts/20211114/capture-logs-in-unit-tests/004_MockLogger.png" width="1564" height="814" alt="VS Code - Dotnet Debugger - mock ILogger registered" /></picture></p>
<h2 id="options-3"><a href="#options-3">Options 3</a></h2>
<p>Thus far, we have discussed options that would work outside <code>Xunit</code>. The third technique is not limited to <code>Xunit</code>, but its implementation is restricted to use in a <code>Xunit</code> project because we will now rely on Xunit's <code>ITestOutputHelper</code> mechanism. In most cases, we would use <code>ITestOutputHelper</code> to log lines inside the test case itself; it is, however, possible to create an <code>ILogger</code> that writes to <code>ITestOutputHelper</code> so we can also capture logs our SUT produces.</p>
<p>Microsoft has <a href="https://docs.microsoft.com/en-us/dotnet/core/extensions/custom-logging-provider" class="external">well-written documentation</a> on how to create a custom logger provider. We start with a configuration class for our <code>XunitLogger</code>. We will have no custom settings in this demo, but putting the configuration in place makes it easier to add settings later. The <code>ConsoleLogger</code>, for example, uses configuration to control LogScope inclusion and timestamp formats.</p>
<pre><code class="language-cs">public class XunitLoggerConfiguration
{
}
</code></pre>
<p>Next up is our Xunit logger itself. The ColoredConsole sample from the docs does nothing with scope, but to not limit ourselves later, we changed the implementation of <code>BeginScope</code> to use <code>IExternalScopeProvider</code>. To print the log line, we need the last argument of <code>Log&lt;TState&gt;</code>, which is the formatter. We then pass it the Xunit's ITestOutputHelper to <a href="https://xunit.net/docs/capturing-output" class="external">capture output</a>. Depending on your specific needs, you can log the logger's category (name), event, log level, scope or even exception. For now, let's keep it simple.</p>
<pre><code class="language-cs">public class XunitLogger : ILogger
{
    private readonly string _loggerName;
    private readonly Func&lt;XunitLoggerConfiguration&gt; _getCurrentConfig;
    private readonly IExternalScopeProvider _externalScopeProvider;
    private readonly ITestOutputHelper _testOutputHelper;

    public XunitLogger(string loggerName, Func&lt;XunitLoggerConfiguration&gt; getCurrentConfig, IExternalScopeProvider externalScopeProvider, ITestOutputHelper testOutputHelper)
    {
        _loggerName = loggerName;
        _getCurrentConfig = getCurrentConfig;
        _externalScopeProvider = externalScopeProvider;
        _testOutputHelper = testOutputHelper;
    }

    public IDisposable BeginScope&lt;TState&gt;(TState state) =&gt; _externalScopeProvider.Push(state);

    public bool IsEnabled(LogLevel logLevel) =&gt; LogLevel.None != logLevel;

    public void Log&lt;TState&gt;(LogLevel logLevel, EventId eventId, TState state, Exception? exception, Func&lt;TState, Exception?, string&gt; formatter)
    {
        if (!IsEnabled(logLevel))
        {
            return;
        }

         var message = formatter(state, exception);
         _testOutputHelper.WriteLine(message);
    }
}
</code></pre>
<p>An <code>ILoggerProvider</code> is responsible for creating <code>ILogger</code> instances; this means we also need the custom <code>XunitLoggerProvider</code> to take care of making our <code>XunitLogger</code>.</p>
<pre><code class="language-cs">public sealed class XunitLoggerProvider : ILoggerProvider
{
    private readonly IDisposable _configurationOnChangeToken;
    private XunitLoggerConfiguration _currentConfiguration;
    private readonly ConcurrentDictionary&lt;string, XunitLogger&gt; _loggers = new();
    private readonly IExternalScopeProvider _externalScopeProvider = new LoggerExternalScopeProvider();
    private readonly ITestOutputHelper _testOutputHelper;

    public XunitLoggerProvider(IOptionsMonitor&lt;XunitLoggerConfiguration&gt; optionsMonitor, ITestOutputHelper testOutputHelper)
    {
        _currentConfiguration = optionsMonitor.CurrentValue;
        _configurationOnChangeToken = optionsMonitor.OnChange(updatedConfiguration =&gt; _currentConfiguration = updatedConfiguration);
        _testOutputHelper = testOutputHelper;
    }

    public ILogger CreateLogger(string categoryName)
    {
        var logger = _loggers.GetOrAdd(categoryName, name =&gt; new XunitLogger(name, GetCurrentConfiguration, _externalScopeProvider, _testOutputHelper));
        return logger;
    }

    public void Dispose()
    {
        _loggers.Clear();
        _configurationOnChangeToken.Dispose();
    }

    private XunitLoggerConfiguration GetCurrentConfiguration() =&gt; _currentConfiguration;
}
</code></pre>
<p>The final puzzle piece is an extension method that allows us to register the new logger type. Note that we also add <code>ITestOutputHelper</code> to the DI container of the LoggingBuilder; that is why the <code>XunitLoggingProvider</code> in the previous snippet can retrieve it from the dependency injection container.</p>
<pre><code class="language-cs">public static class XunitLoggingBuilderExtensions
{
    public static ILoggingBuilder AddXunit(this ILoggingBuilder builder, ITestOutputHelper testOutputHelper)
    {
        builder.AddConfiguration();

        builder.Services.TryAddSingleton(testOutputHelper);

        builder.Services.TryAddEnumerable(
            ServiceDescriptor.Singleton&lt;ILoggerProvider, XunitLoggerProvider&gt;());

        LoggerProviderOptions.RegisterProviderOptions
            &lt;XunitLoggerConfiguration, XunitLoggerProvider&gt;(builder.Services);

        return builder;
    }

    public static ILoggingBuilder AddXunit(this ILoggingBuilder builder, ITestOutputHelper testOutputHelper, Action&lt;XunitLoggerConfiguration&gt; configure)
    {
        builder.AddXunit(testOutputHelper);
        builder.Services.Configure(configure);

        return builder;
    }
}
</code></pre>
<p>The usage is the same as the ConsoleLogger example we did previously.</p>
<pre><code class="language-cs">[Fact]
public async Task Test_Custom_XunitLoggingBuilder()
{
    var configuration = new ConfigurationBuilder().Build();
    var serviceProvider = new ServiceCollection()
        .AddLogging(loggingBuilder =&gt; {
            loggingBuilder.AddXunit(_testOutputHelper);
        })
        .AddEcho(configuration)
        .BuildServiceProvider();
    var sut = serviceProvider.GetRequiredService&lt;IEchoService&gt;();
    var testInput = &quot;Scenario: custom logging builder&quot;;
    var testResult = await sut.Echo(testInput).ConfigureAwait(false);
    testResult.Should().Be(testInput, &quot;the input should have been returned&quot;);
}
</code></pre>
<p><picture><source type="image/webp" srcset="https://BaseUrl_1/assets/images/posts/20211114/capture-logs-in-unit-tests/005_XunitLogger.png.webp"><img loading="lazy" src="https://BaseUrl_1/assets/images/posts/20211114/capture-logs-in-unit-tests/005_XunitLogger.png" width="1564" height="814" alt="VS Code - Dotnet Debugger - Xunit ILogger registered" /></picture></p>
<p>The first time I ran this test, I was baffled. I could only see the console output from ConsoleLogger test we did previously. A quick google search brought me to the <a href="https://github.com/xunit/xunit/issues/1141#issuecomment-555717377" class="external">solution</a>. We need to tell the dotnet test runner to display it with <code>dotnet test --logger:&quot;console;verbosity=detailed&quot;</code>. Telling an entire team they can no longer simply run <code>dotnet test</code> was not a real solution; luckily, we can simplify things with <code>dotnet test --settings runsettings.xml</code>.</p>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;
&lt;RunSettings&gt;
    &lt;LoggerRunSettings&gt;
        &lt;Loggers&gt;
            &lt;Logger friendlyName=&quot;console&quot; enabled=&quot;True&quot;&gt;
                &lt;Configuration&gt;
                    &lt;Verbosity&gt;detailed&lt;/Verbosity&gt;
                &lt;/Configuration&gt;
            &lt;/Logger&gt;
        &lt;/Loggers&gt;
    &lt;/LoggerRunSettings&gt;
&lt;/RunSettings&gt;
</code></pre>
<p>However, explicitly passing <code>--settings</code> every time does not solve anything. On the <a href="https://docs.microsoft.com/en-us/visualstudio/test/configure-unit-tests-by-using-a-dot-runsettings-file?view=vs-2022" class="external">Microsoft Docs</a> I found the solution. We can tell MSBuild to use <code>RunSettingsFilePath</code>, which takes care of it for us. If we now run <code>dotnet test</code> we get proper output. For example, you can add a <code>Directory.Build.props</code> to the root of your project.</p>
<pre><code class="language-xml">&lt;Project&gt;
  &lt;PropertyGroup&gt;
    &lt;RunSettingsFilePath&gt;$(MSBuildThisFileDirectory)runsettings.xml&lt;/RunSettingsFilePath&gt;
  &lt;/PropertyGroup&gt;
&lt;/Project&gt;
</code></pre>
<h2 id="closing-thoughts"><a href="#closing-thoughts">Closing Thoughts</a></h2>
<p>I know I am not the first to write about this topic, but I hope to provide fresh insight into the subject matter. The different techniques all have their merit. I have used all three on other occasions and remind you that the NullLogger is a viable option in many cases. Nine times out of 10, you probably only care about the business logic to test. For the final remaining time, I can only say the well-known programming wisdom: &quot;It depends&quot;.</p>
<p>As always, if you have any questions, feel free to reach out. Do you have suggestions or alternatives? I would love to hear about them.</p>
<p>The corresponding source code for this article is on <a href="https://github.com/kaylumah/CaptureLogsInUnitTests" class="external">GitHub</a>.</p>
<p>See you next time, stay healthy and happy coding to all 🧸!</p>
        </main>
        <footer class="">
            
                        <!-- https://giscus.app -->
                        <!-- https://github.com/giscus/giscus/blob/main/ADVANCED-USAGE.md -->
                        <script src="https://giscus.app/client.js"
                            data-repo="kaylumah/hosting"
                            data-repo-id="MDEwOlJlcG9zaXRvcnkzMzgyNzg4MzU="
                            data-mapping="number"
                            data-term="141"
                            data-reactions-enabled="1"
                            data-emit-metadata="0"
                            data-input-position="top"
                            data-theme="light_high_contrast"
                            data-lang="en"
                            data-loading="lazy"
                            crossorigin="anonymous"
                            async>
                        </script>
                        
        </footer>
    </article>
    <ul id="tiles" class="flex-none flex flex-col items-center gap-4">
        <li class="w-full laptop:w-64">
            <div class="bg-slate-50 border-2 p-6 flex flex-col items-center gap-2">
                <img class="rounded-full h-32 w-32" src="/assets/avatar_background.svg" alt="Kaylumah Hero" />
                <h2 class="text-xl font-semibold">Max Hamulyák</h2>
                <span>aka Kaylumah</span>
            </div>
        </li>
        <li class="w-full laptop:w-64">
            <div class="bg-slate-50 border-2 p-6 flex flex-col items-center gap-2">
                <h2 class="text-xl font-semibold">Sponsors</h2>
                <p>
                    Enjoy reading my content? Consider becoming a sponsor for the blog.
                    This will help keep the blog up and running! 
                </p>
                <ul class="flex flex-row items-center gap-2">
                    <li>
                        <a href="https://www.buymeacoffee.com/kaylumah" target="_blank">
                            <svg class="block h-8 w-8" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none">
                                <!-- https://simpleicons.org -->
                                <title>Buy Me A Coffee</title>
                                <path fill="#FFDD00" d="M20.216 6.415l-.132-.666c-.119-.598-.388-1.163-1.001-1.379-.197-.069-.42-.098-.57-.241-.152-.143-.196-.366-.231-.572-.065-.378-.125-.756-.192-1.133-.057-.325-.102-.69-.25-.987-.195-.4-.597-.634-.996-.788a5.723 5.723 0 00-.626-.194c-1-.263-2.05-.36-3.077-.416a25.834 25.834 0 00-3.7.062c-.915.083-1.88.184-2.75.5-.318.116-.646.256-.888.501-.297.302-.393.77-.177 1.146.154.267.415.456.692.58.36.162.737.284 1.123.366 1.075.238 2.189.331 3.287.37 1.218.05 2.437.01 3.65-.118.299-.033.598-.073.896-.119.352-.054.578-.513.474-.834-.124-.383-.457-.531-.834-.473-.466.074-.96.108-1.382.146-1.177.08-2.358.082-3.536.006a22.228 22.228 0 01-1.157-.107c-.086-.01-.18-.025-.258-.036-.243-.036-.484-.08-.724-.13-.111-.027-.111-.185 0-.212h.005c.277-.06.557-.108.838-.147h.002c.131-.009.263-.032.394-.048a25.076 25.076 0 013.426-.12c.674.019 1.347.067 2.017.144l.228.031c.267.04.533.088.798.145.392.085.895.113 1.07.542.055.137.08.288.111.431l.319 1.484a.237.237 0 01-.199.284h-.003c-.037.006-.075.01-.112.015a36.704 36.704 0 01-4.743.295 37.059 37.059 0 01-4.699-.304c-.14-.017-.293-.042-.417-.06-.326-.048-.649-.108-.973-.161-.393-.065-.768-.032-1.123.161-.29.16-.527.404-.675.701-.154.316-.199.66-.267 1-.069.34-.176.707-.135 1.056.087.753.613 1.365 1.37 1.502a39.69 39.69 0 0011.343.376.483.483 0 01.535.53l-.071.697-1.018 9.907c-.041.41-.047.832-.125 1.237-.122.637-.553 1.028-1.182 1.171-.577.131-1.165.2-1.756.205-.656.004-1.31-.025-1.966-.022-.699.004-1.556-.06-2.095-.58-.475-.458-.54-1.174-.605-1.793l-.731-7.013-.322-3.094c-.037-.351-.286-.695-.678-.678-.336.015-.718.3-.678.679l.228 2.185.949 9.112c.147 1.344 1.174 2.068 2.446 2.272.742.12 1.503.144 2.257.156.966.016 1.942.053 2.892-.122 1.408-.258 2.465-1.198 2.616-2.657.34-3.332.683-6.663 1.024-9.995l.215-2.087a.484.484 0 01.39-.426c.402-.078.787-.212 1.074-.518.455-.488.546-1.124.385-1.766zm-1.478.772c-.145.137-.363.201-.578.233-2.416.359-4.866.54-7.308.46-1.748-.06-3.477-.254-5.207-.498-.17-.024-.353-.055-.47-.18-.22-.236-.111-.71-.054-.995.052-.26.152-.609.463-.646.484-.057 1.046.148 1.526.22.577.088 1.156.159 1.737.212 2.48.226 5.002.19 7.472-.14.45-.06.899-.13 1.345-.21.399-.072.84-.206 1.08.206.166.281.188.657.162.974a.544.544 0 01-.169.364zm-6.159 3.9c-.862.37-1.84.788-3.109.788a5.884 5.884 0 01-1.569-.217l.877 9.004c.065.78.717 1.38 1.5 1.38 0 0 1.243.065 1.658.065.447 0 1.786-.065 1.786-.065.783 0 1.434-.6 1.499-1.38l.94-9.95a3.996 3.996 0 00-1.322-.238c-.826 0-1.491.284-2.26.613z"/>
                            </svg>
                        </a>
                    </li>
                    <li>
                        <a href="https://github.com/sponsors/kaylumah" target="_blank">
                            <svg class="block h-8 w-8" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none">
                                <!-- https://simpleicons.org -->
                                <title>GitHub Sponsors</title>
                                <path fill="#EA4AAA" d="M17.625 1.499c-2.32 0-4.354 1.203-5.625 3.03-1.271-1.827-3.305-3.03-5.625-3.03C3.129 1.499 0 4.253 0 8.249c0 4.275 3.068 7.847 5.828 10.227a33.14 33.14 0 0 0 5.616 3.876l.028.017.008.003-.001.003c.163.085.342.126.521.125.179.001.358-.041.521-.125l-.001-.003.008-.003.028-.017a33.14 33.14 0 0 0 5.616-3.876C20.932 16.096 24 12.524 24 8.249c0-3.996-3.129-6.75-6.375-6.75zm-.919 15.275a30.766 30.766 0 0 1-4.703 3.316l-.004-.002-.004.002a30.955 30.955 0 0 1-4.703-3.316c-2.677-2.307-5.047-5.298-5.047-8.523 0-2.754 2.121-4.5 4.125-4.5 2.06 0 3.914 1.479 4.544 3.684.143.495.596.797 1.086.796.49.001.943-.302 1.085-.796.63-2.205 2.484-3.684 4.544-3.684 2.004 0 4.125 1.746 4.125 4.5 0 3.225-2.37 6.216-5.048 8.523z"/>
                            </svg>
                        </a>
                    </li>
                </ul>
            </div>
        </li>
        <li class="w-full laptop:w-64">
            
            
            
            <div class="bg-slate-50 border-2 p-6 flex flex-col items-center gap-2">
                <h2 class="text-xl font-semibold">Popular posts</h2>
                <ul class="flex flex-col gap-2">
                    
                            <li>
                                <a href="/blog/2021/04/11/an-approach-to-writing-mocks.html">Experiment with Moq, an approach to writing mocks</a>
                            </li>
                            
                            <li>
                                <a href="/blog/2019/09/07/using-csharp-code-your-git-hooks.html">Using C# code in your git hooks</a>
                            </li>
                            
                </ul>
            </div>

        </li>
        <li class="w-full laptop:w-64">
            
            
            
        </li>
        <li class="w-full laptop:w-64">
            <div class="bg-slate-50 border-2 p-6 flex flex-col items-center gap-2">
                <h2 class="text-xl font-semibold">Tags</h2>
                <ul id="word-cloud" class="flex justify-center flex-wrap align-center gap-2 leading-8">
                </ul>
                <script>
                var words = [];
                
                var container = document.getElementById('word-cloud');
                words.forEach(word => {
                  const li = document.createElement('li');
                  const anchor = document.createElement('a');
                  anchor.href = word.Uri;
                  anchor.title = word.Description;
                  anchor.text = `${word.DisplayName} (${word.Size})`;
                  const x = word.Size;
                  switch(true)
                  {
                    case (x < 2):
                      anchor.classList = "text-md"//; text-gray-500";
                      break;
                    case (x < 4):
                      anchor.classList = "text-lg"//; text-blue-500";
                      break;
                    case (x < 6):
                      anchor.classList = "text-xl"//; text-red-500";
                      break;
                    default:
                      anchor.classList = "text-2xl"//; text-green-500";
                      break;
                  }
                
                  li.appendChild(anchor);
                  container.appendChild(li);
                });  
                </script>
            </div>
        </li>
    </ul>
</div>

        </main>
        <footer class="bg-gray-900 p-4">
            <div class="flex flex-col text-center text-gray-100">
                <span data-testid="Footer-CopyrightNotice">© Kaylumah. All rights reserved.</span>
                <!-- <span class="text-xs">Deployed from commit <a data-testid="FooterLink-CommitId" class="hover:text-gray-400" href="https://github.com/kaylumah/hosting/commit/[COMMIT-HASH]">[SHORT-COMMIT-HASH]</a> via build <a data-testid="FooterLink-BuildId" class="hover:text-gray-400" href="https://github.com/kaylumah/hosting/actions/runs/[BUILD-ID]">BuildNumber_1</a></span> -->
            </div>
        </footer>
        <div id="cookie-banner" class="fixed inset-x-0 bottom-0 z-10 flex flex-col justify-between gap-x-8 gap-y-4 bg-white p-6 tablet:flex-row tablet:items-center laptop:px-8">
            <p class="text-sm leading-6 text-gray-900">This website uses cookies to enhance your browsing experience, analyze site traffic, and serve better user experiences. By continuing to use this site, you consent to our use of cookies. Learn more in our <a class="font-semibold text-teal-900" href="/privacy">cookie policy</a>.</p>
            <div class="mr-16 flex flex-none items-center gap-x-5">
                <button onclick="handleCookieConsentGranted()" type="button" class="rounded-md bg-gray-900 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-gray-700">Accept all</button>
                <button onclick="handleCookieConsentDenied()" type="button" class="text-sm font-semibold leading-6 text-gray-900">Reject all</button>
            </div>
            <script>

                window.hideCookieBanner = function() {
                    let cookieBanner = document.getElementById("cookie-banner");
                    cookieBanner.classList.toggle("hidden");
                }
    
                window.handleCookieConsentGranted = function() {
                  window.setCookieConsent("granted");
                  window.setGtagConsentStatus("update", "granted");
                  window.hideCookieBanner();
                }
              
                window.handleCookieConsentDenied = function() {
                    window.setCookieConsent("denied");
                    window.setGtagConsentStatus("update", "denied");
                    window.hideCookieBanner();
                }
    
                let hideCookieBanner = window.getCookieConsent() != "unknown";
                if (hideCookieBanner)
                {
                    window.hideCookieBanner();
                }
              
            </script>
        </div>
    </div>
</body>

</html>