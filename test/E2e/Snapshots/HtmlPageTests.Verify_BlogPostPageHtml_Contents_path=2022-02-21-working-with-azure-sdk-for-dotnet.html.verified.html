<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="icon" href="/assets/images/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon-16x16.png" />
    <link rel="manifest" href="/assets/images/site.webmanifest" />
    <link rel="mask-icon" href="/assets/images/safari-pinned-tab.svg" color="DarkGreen" />

    <link href="/compiled.css?v=[SHORT-COMMIT-HASH]" rel="stylesheet" />

    <!-- Begin Kaylumah SEO tag v[SHORT-COMMIT-HASH] -->
    
    <!-- Common Meta Tags -->
    <title>Working with Azure SDK for .NET</title>
    <link rel="canonical" href="https://BaseUrl_1/2022/02/21/working-with-azure-sdk-for-dotnet.html" />
    <link rel="alternate" type="application/atom+xml" href="https://BaseUrl_1/feed.xml" title="Max Hamulyák · Kaylumah RSS Feed" />
    <link rel="sitemap" type="application/xml" href="https://BaseUrl_1/sitemap.xml" title="Max Hamulyák · Kaylumah Sitemap" />
    <meta name="generator" content="Kaylumah v[SHORT-COMMIT-HASH]" />
    <meta name="description" content="The latest iteration of the Azure SDK for dotnet has several cool features baked into its design. We take a look at some common scenarios" />
    <meta name="copyright" content="© Kaylumah. All rights reserved." />
    <meta name="keywords" content="csharp, azure" />
    
    <!-- OpenGraph Meta Tags -->
    <meta property="og:type" content="article" />
    <meta property="og:locale" content="en" />
    <meta property="og:site_name" content="Max Hamulyák · Kaylumah" />
    <meta property="og:title" content="Working with Azure SDK for .NET" />
    <meta property="og:url" content="https://BaseUrl_1/2022/02/21/working-with-azure-sdk-for-dotnet.html" />
    <meta property="og:description" content="The latest iteration of the Azure SDK for dotnet has several cool features baked into its design. We take a look at some common scenarios" />
    <meta property="og:image" content="https://BaseUrl_1/assets/images/posts/20220221/working-with-azure-sdk-for-dotnet/cover_image.png" />
    <meta property="article:author" content="Max Hamulyák" />
    <meta property="article:published_time" content="2022-02-21T21:30:00.0000000+01:00" />
    <meta property="article:modified_time" content="2022-02-21T21:30:00.0000000+01:00" />
    <meta property="article:tag" content="csharp" />
    <meta property="article:tag" content="azure" />
    
    <!-- Twitter Meta Tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Working with Azure SDK for .NET" />
    <meta name="twitter:description" content="The latest iteration of the Azure SDK for dotnet has several cool features baked into its design. We take a look at some common scenarios" />
    <meta name="twitter:image" content="https://BaseUrl_1/assets/images/posts/20220221/working-with-azure-sdk-for-dotnet/cover_image.png" />
    <meta name="twitter:site" content="@kaylumah" />
    <meta name="twitter:creator" content="@kaylumah" />
    
    <!-- Mastodon Meta Tags -->
    <link rel="me" href="https://mastodon.nl/@kaylumah" />
    
    <!-- Kaylumah BuildInfo Meta Tags -->
    <meta property="kaylumah:copyright" content="© Kaylumah. All rights reserved." />
    <meta property="kaylumah:commit" content="[COMMIT-HASH]" />
    <meta property="kaylumah:version" content="1.0.0.BuildNumber_1" />
    <meta property="kaylumah:buildId" content="[BUILD-ID]" />
    <meta property="kaylumah:buildNumber" content="BuildNumber_1" />
    <meta property="kaylumah:time" content="DateTimeOffset_1" />
    <meta property="kaylumah:site" content="Guid_1" />
    <meta property="kaylumah:page" content="Guid_2" />
    
    <!-- LdJson Meta Tags -->
    <script type="application/ld+json">{
      "@context": "https://schema.org",
      "@type": "BlogPosting",
      "description": "The latest iteration of the Azure SDK for dotnet has several cool features baked into its design. We take a look at some common scenarios",
      "image": "https://BaseUrl_1/assets/images/posts/20220221/working-with-azure-sdk-for-dotnet/cover_image.png",
      "mainEntityOfPage": "https://BaseUrl_1/2022/02/21/working-with-azure-sdk-for-dotnet.html",
      "url": "https://BaseUrl_1/2022/02/21/working-with-azure-sdk-for-dotnet.html",
      "author": {
        "@context": "https://schema.org",
        "@type": "Person",
        "name": "Max Hamulyák",
        "image": "https://BaseUrl_1/assets/avatar_background.svg",
        "sameAs": [
          "https://www.linkedin.com/in/maxhamulyak",
          "https://twitter.com/kaylumah"
        ],
        "email": "max@kaylumah.nl"
      },
      "dateModified": "2022-02-21T21:30:00+01:00",
      "datePublished": "2022-02-21T21:30:00+01:00",
      "headline": "Working with Azure SDK for .NET",
      "inLanguage": "en",
      "keywords": "csharp,azure",
      "publisher": {
        "@context": "https://schema.org",
        "@type": "Organization",
        "name": "kaylumah",
        "sameAs": "https://www.linkedin.com/company/kaylumah",
        "foundingDate": "2020-01-01",
        "logo": "https://BaseUrl_1/assets/logo.svg"
      },
      "timeRequired": "PT8M",
      "wordCount": 1867
    }</script>
    
    <!-- End Kaylumah SEO tag -->
    <!--
                                                        
       _  __           _                       _        
      | |/ /__ _ _   _| |_   _ _ __ ___   __ _| |__     
      | ' // _` | | | | | | | | '_ ` _ \ / _` | '_ \    
      | . \ (_| | |_| | | |_| | | | | | | (_| | | | |   
      |_|\_\__,_|\__, |_|\__,_|_| |_| |_|\__,_|_| |_|   
                 |___/                                  
                                                        
     You found 🧸                                      
                                                       
    -->
    
    <script>
    
      const consoleSignatureText = '%c👨‍💻 Thank you for your visit to my little spot on the internet, be welcome! 🧸';
      const consoleSignatureStyle = `
      font-size: 16px;
      background: #4cae50;
      color: white;
      text-align: center;
      padding: 10px 15px;
      width: 100%;
      border-radius: 20px;
    `;
      console.log(consoleSignatureText, consoleSignatureStyle);
    </script>
    <script>
      window.getCookieConsent = function() {
          try {
              const consent = document.cookie.match(/cookie-consent=([^;]+)/)[1];
              return consent;
          } catch (error) {
              console.log("failed to retrieve consent", error);
              return "unknown";
          }
      };
    
      window.setCookieConsent = function(status) {
    
        if (status != "denied" && status != "granted") {
          throw new Error(`Status ${status} is not supported!`);
        }
    
        let today = new Date();
        let expiryDate = new Date(today.getFullYear() + 1, today.getMonth(), today.getDate());
        document.cookie = `cookie-consent=${status}; expires=${expiryDate}; path=/`;
      }
    
    </script>
    <script>
      // Define dataLayer and the gtag function.
      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
    
      window.setGtagConsentStatus = function(mode, status) {
    
        if (mode != "update" && mode != "default") {
          throw new Error(`Mode ${mode} is not supported!`);
        }
    
        if (status != "denied" && status != "granted") {
          throw new Error(`Status ${status} is not supported!`);
        }
    
        gtag('consent', mode, {
          'ad_storage': status,
          'ad_user_data': status,
          'ad_personalization': status,
          'analytics_storage': status
        });
      }
    
      let currentStatus = window.getCookieConsent();
      let cookiesAllowed = currentStatus == "granted";
    
      if (cookiesAllowed) {
        console.log("cookies already approved");
        window.setGtagConsentStatus("default", "granted");
      } else {
        console.log("assume cookies are denied");
        window.setGtagConsentStatus("default", "denied");
      }
    </script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MEQZVWN0D7">
    </script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
    
      gtag('js', new Date());
      gtag('config', 'G-MEQZVWN0D7');
    </script>
</head>

<body class="bg-gray-100 font-sans leading-relaxed tracking-wide min-h-screen flex flex-col">
<header class="bg-white shadow-md fixed top-0 left-0 w-full z-50 h-[var(--header-height)]">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
        <!-- Logo -->
        <a href="/" class="flex items-center">
            <img data-testid="NavLogo" class="h-12 w-auto" src="/assets/logo.svg" alt="Kaylumah" />
        </a>

        <!-- Desktop Navigation -->
        <nav class="hidden lg:flex space-x-6">
            
                        <a href="/about.html" class="text-gray-700 hover:text-gray-900">About</a>
                        
                        <a href="/blog.html" class="text-gray-700 hover:text-gray-900">Blog</a>
                        
        </nav>

        <!-- Mobile Menu Button -->
        <button id="mobile-menu-btn" class="lg:hidden text-gray-700 focus:outline-none">
            <svg class="toggle block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewbox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
            <svg class="toggle hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewbox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    </div>

    <!-- Mobile Navigation -->
    <nav id="mobile-menu" class="hidden bg-white lg:hidden px-4 py-3 space-y-2 shadow-md">
        
                <a href="/about.html" class="block text-gray-700 hover:text-gray-900">About</a>
                
                <a href="/blog.html" class="block text-gray-700 hover:text-gray-900">Blog</a>
                
    </nav>

    <script>
        document.getElementById('mobile-menu-btn').onclick = function toggleMenu() {
            document.getElementById('mobile-menu').classList.toggle('hidden');
            const navIcons = document.getElementsByClassName('toggle');
            for (let i = 0; i < navIcons.length; i++) {
                navIcons[i].classList.toggle('hidden');
            }
        };
    </script>
</header>
<div class="flex-1 container mx-auto px-4 py-8 pt-[var(--header-spacing)]">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Main Content -->
    <main class="lg:col-span-2">
        <section class="bg-white rounded-2xl border border-gray-200 p-6">
            
<article class="prose max-w-none">
    <header class="mb-4 border-b border-gray-300 pb-4">
        <h1 class="text-3xl font-bold">Working with Azure SDK for .NET</h1>
        <div class="flex flex-wrap items-center text-gray-600 text-sm mt-2 gap-2">
            <span>Published on <time datetime="2022-02-21">2022/02/21</time></span>
            <span>by <strong>Max Hamulyák</strong></span>
        </div>
        <div class="flex gap-2 mt-2">
            
                        <a href="/blog.html?tag=csharp" class="text-gray-700 text-xs bg-gray-200 px-2 py-1 rounded">#C#</a>
                        
                        <a href="/blog.html?tag=azure" class="text-gray-700 text-xs bg-gray-200 px-2 py-1 rounded">#Azure</a>
                        
        </div>
    </header>
    <section>
        <p>February 2022 marks the 20th anniversary of the dotnet platform, which is quite a milestone. I found it the perfect time to reflect; I have been working professionally for almost six years and using .NET during the four years before that in my studies. For a dotnet blogger like myself, I could not stand idly by and let this pass without a post. February 2022 also marks another milestone for me. My first ever open-source contribution has been released into the wild. I made a <a href="https://github.com/Azure/azure-sdk-for-net/blob/main/sdk/servicebus/Azure.Messaging.ServiceBus/CHANGELOG.md#760-2022-02-08" class="external">small contribution</a> to the <code>Azure SDK for .NET</code>. So in honour of both, I wrote this article with small tips and tricks I picked up when working with the SDK.</p>
<h2 id="which-azure-sdk-should-i-use"><a href="#which-azure-sdk-should-i-use">Which Azure SDK should I use?</a></h2>
<p>Since <a href="https://devblogs.microsoft.com/azure-sdk/state-of-the-azure-sdk-2021/" class="external">July 2019</a>, Microsoft has made a design effort to unify the SDKs for the different services. There are shared concepts between the libraries like authentication and diagnostics. The libraries follow the pattern <code>Azure.{service}.{library}</code>.
My contribution was to the ServiceBus SDK, so today's article focus is the service bus. Almost everything described is transferable to the other SDKs; only a few bits are ServiceBus specific. The NuGet package we need is the <code>Azure.Messaging.Service</code> package.</p>
<h2 id="how-to-set-up-azure-service-bus-with-azure-cli"><a href="#how-to-set-up-azure-service-bus-with-azure-cli">How to set up Azure Service Bus with Azure CLI?</a></h2>
<p>I think the local development aspect of any service is as important as ease of use in production. Unfortunately, there is no way to emulate the service bus locally; Jimmy Bogard wrote about that in <a href="https://jimmybogard.com/local-development-with-azure-service-bus/" class="external">this article</a>. Without emulating, we need to set up our resources in Azure, even for our development environment. There are a few possible options to create resources in Azure:</p>
<ul>
<li>Manually via the Azure Portal</li>
<li>Infrastructure as Code (ARM, Bicep, etc.)</li>
<li>Scripting (Azure CLI, Azure Powershell Module)</li>
</ul>
<p>For prototypes such as this article, I prefer Azure CLI since the commands are repeatable and, more importantly, easy to understand.</p>
<blockquote>
<p><strong>NOTE</strong>:</p>
<p>When I work with the Azure CLI, I use the <a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode.azurecli" class="external">Azure CLI Tools</a> extension for VS Code. It provides Intellisense and snippets to work with the CLI.</p>
</blockquote>
<pre><code class="language-sh">AzureSubscriptionId=&quot;&lt;subscription-id&gt;&quot;
AzureTenantId=&quot;&lt;tenant-id&gt;&quot;
AzureResourceGroup=&quot;demorg001&quot;
AzureLocation=&quot;westeurope&quot;

# Sign in to Azure using device code - After login session is scoped to Subscription in Tenant
az login --use-device-code --tenant $AzureTenantId
az account set --subscription $AzureSubscriptionId

# Set default values for location and resource group
az config set defaults.location=$AzureLocation defaults.group=$AzureResourceGroup

# Create resource group and capture resource group identifier
ResourceGroupId=$(az group create --name $AzureResourceGroup --query &quot;id&quot; --output tsv)

# Generate Unique ID based on ResourceGroupId
UniqueId=$(echo -n $ResourceGroupId | md5sum | cut -c-13)

# Create ServiceBus and Queue
ServiceBusNamespace=&quot;sbdemo0001$UniqueId&quot;
QueueName=&quot;demoqueue&quot;
echo &quot;Going to create ServiceBus $ServiceBusNamespace and Queue $QueueName&quot;
AzureServiceBusId=$(az servicebus namespace create --name $ServiceBusNamespace --sku Basic --query id -o tsv)
AzureServiceBusQueueId=$(az servicebus queue create --name $QueueName --namespace-name $ServiceBusNamespace --default-message-time-to-live P0Y0M0DT0H0M30S --query id -o tsv)

# Fetch ServiceBus Connectionstring
PrimaryConnectionString=$(az servicebus namespace authorization-rule keys list \
    --namespace-name $ServiceBusNamespace \
    --name &quot;RootManageSharedAccessKey&quot; \
    --query &quot;primaryConnectionString&quot; \
    --output tsv)

echo &quot;$PrimaryConnectionString&quot;
</code></pre>
<blockquote>
<p><strong>Note</strong></p>
<p>The above snippet uses the default generated RootManageSharedAccessKey, which provides full access to your servicebus so use with caution!</p>
</blockquote>
<h2 id="how-does-the-azure-service-bus-sdk-work"><a href="#how-does-the-azure-service-bus-sdk-work">How does the Azure Service Bus SDK work?</a></h2>
<p>A message bus is dependent on both a sender and receiver for communication. There are many examples in the <a href="https://github.com/Azure/azure-sdk-for-net/tree/main/sdk/servicebus/Azure.Messaging.ServiceBus" class="external">official GitHub repo</a>, so I won't go into much more details regarding the bus itself.</p>
<p>This demo will focus on SDK features, so I created an Xunit project that runs multiple scenarios. Since all scenarios require some logic to communicate with the bus, I made the following extension method to avoid unnecessary boilerplate. In a real-world application sending and receiving messages using the ServiceBusClient would not be hidden behind a single extension method.</p>
<pre><code class="language-csharp">using System;
using System.Threading.Tasks;
using Azure.Messaging.ServiceBus;
using FluentAssertions;

namespace Test.Integration;

public static partial class ServiceBusClientTestExtensions
{
    public static async Task RunScenario(this ServiceBusClient client, string queueName, string scenarioName)
    {
        var sender = client.CreateSender(queueName);
        var receiver = client.CreateReceiver(queueName);

        var message = $&quot;{scenarioName}-{DateTimeOffset.Now:s}&quot;;
        await sender.SendMessageAsync(new ServiceBusMessage(message));
        var receivedMessage = await receiver.ReceiveMessageAsync();

        receivedMessage.Body.ToString().Should().Be(message);
        await Task.Delay(TimeSpan.FromSeconds(35));
    }
}
</code></pre>
<p>The default method described by the docs is to pass the ServiceBusConnection string to the ServiceBusClient and create it as needed.</p>
<pre><code class="language-csharp">public class UnitTest1
{
    private const string ConnectionString = &quot;&lt;your-connectionstring&gt;&quot;;
    private const string QueueName = &quot;demoqueue&quot;;

    [Fact]
    public async Task Test_Scenario01_UsePrimaryConnectionString()
    {
        await using var client = new ServiceBusClient(ConnectionString);
        var scenario = async () =&gt; await client.RunScenario(QueueName, nameof(Test_Scenario01_UsePrimaryConnectionString));
        await scenario();
    }
}
</code></pre>
<blockquote>
<p><strong>Warning</strong></p>
<p>Never store credentials in source control!</p>
</blockquote>
<h2 id="how-to-use-azure-sdk-without-connection-strings"><a href="#how-to-use-azure-sdk-without-connection-strings">How to use Azure SDK without connection strings?</a></h2>
<p>Working with secrets like our connection string provides extra overhead. Luckily this incarnation of the Azure SDK embraces token authentication via TokenCredential. For this, we need to install the package <code>Azure.Identity</code>. Using this method is the preferred method of authenticating the Azure SDK.
The easiest way to use this SDK is by creating a <code>DefaultAzureCredential</code>, which attempts to authenticate with a couple of common authentication mechanisms in order.</p>
<ol>
<li>Environment</li>
<li>Managed Identity</li>
<li>Visual Studio</li>
<li>Azure CLI</li>
<li>Azure Powershell</li>
</ol>
<pre><code class="language-csharp">public class UnitTest1
{
    private const string FullyQualifiedNamespace = &quot;&lt;your-namespace&gt;.servicebus.windows.net&quot;;
    private const string QueueName = &quot;demoqueue&quot;;

    [Fact]
    public async Task Test_Scenario02_UseFullyQualifiedNamespace()
    {
        await using var client = new ServiceBusClient(FullyQualifiedNamespace, new DefaultAzureCredential());
        var scenario = async () =&gt; await client.RunScenario(QueueName, nameof(Test_Scenario02_UseFullyQualifiedNamespace));
        await scenario();
    }
}
</code></pre>
<p>Seeing the snippet, you might wonder how is providing <code>your-namespace.servicebus.windows.net</code> any better than a connection string? It's a good question; you still should not store something like that as plain text in source control. For one thing, it will probably be environment-specific. We still need it because we need an address so our application can communicate with Azure. The big difference here is that our address does not contain the key; the address alone is not enough to provide access to our resources.</p>
<p>Depending on how your organization handles roles and access management in Azure, you can now run this test and achieve the same result as before, without those pesky connection strings.
For example, since I created a service bus, my user is the owner of that bus. Being the service bus instance owner is not enough to authenticate and successfully run our scenario. I require one of the service bus specific data roles. You can find a list of supported under <code>Access Control (IAM)</code> in the portal. I opted to use the <code>&quot;Azure Service Bus Data Owner&quot;</code> role for this tutorial.
The tricky bit is that role management in Azure is very granular. When I assign a role, I need to select a scope:</p>
<ul>
<li>subscription</li>
<li>resourceGroup</li>
<li>resource (i.e. ServiceBusNamespace)</li>
<li>child resource (i.e. queue)</li>
</ul>
<p>Scopes are inherited, so if I assign my user a role on a resource group, all resources (if applicable) in that resource group will provide me with the same access.</p>
<p>We can update our Azure CLI script to provide the logged-in user access to the resource.</p>
<pre><code class="language-sh"># Assign Role &quot;Azure Service Bus Data Owner&quot; for the current user
UserIdentity=$(az ad signed-in-user show --query objectId -o tsv)
az role assignment create --assignee $UserIdentity --role &quot;Azure Service Bus Data Owner&quot; --scope $AzureServiceBusId
</code></pre>
<p>Now you know why the previous script captured the AzureServiceBusId ;-)</p>
<p>One thing to note is that DefaultAzureCredential's intended use is to simplify getting started with development. In a real-world application, you would probably need a custom ChainedTokenCredential that uses ManagedIdentityCredential for production and AzureCliCredential for development.</p>
<h2 id="how-can-i-use-the-azure-sdk-with-dependency-injection"><a href="#how-can-i-use-the-azure-sdk-with-dependency-injection">How can I use the Azure SDK with Dependency Injection?</a></h2>
<p>One thing that always bothered me with the code I have shown so far is creating clients on the fly. I prefer to receive my service bus client from the dependency injection container. Discovering that this was a viable solution caused me to submit that PR to the Azure SDK repo. The team had already provided the normal ServiceBusClient, so I recreated the extension method to make ServiceBusAdministrationClient available via DI. It's time to install our third NuGet package, <code>Microsoft.Extensions.Azure</code> which provides the necessary bits.</p>
<p>After installing the package, we get the <code>AddAzureClients</code> extension method on IServiceCollection. It provides access to the <code>AzureClientFactoryBuilder</code> on which we can register everything Azure SDK related. In the case of ServiceBus we get <code>AddServiceBusClient</code> and <code>AddServiceBusClientWithNamespace</code>. I like that these methods are much more explicit than the constructor.</p>
<pre><code class="language-csharp">public class UnitTest1
{
    private const string FullyQualifiedNamespace = &quot;&lt;your-namespace&gt;.servicebus.windows.net&quot;;
    private const string ConnectionString = &quot;&lt;your-connectionstring&gt;&quot;;
    private const string QueueName = &quot;demoqueue&quot;;

    [Fact]
    public async Task Test_Scenario03_UseDependencyInjectionWithPrimaryConnectionString()
    {
        var services = new ServiceCollection();
        services.AddAzureClients(builder =&gt; {
            builder.AddServiceBusClient(ConnectionString);
        });
        var serviceProvider = services.BuildServiceProvider();
        var client = serviceProvider.GetRequiredService&lt;ServiceBusClient&gt;();
        var scenario = async () =&gt; await client.RunScenario(QueueName, nameof(Test_Scenario03_UseDependencyInjectionWithPrimaryConnectionString));
        await scenario();
    }

    [Fact]
    public async Task Test_Scenario04_UseDependencyInjectionWithFullyQualifiedNamespace()
    {
        var services = new ServiceCollection();
        services.AddAzureClients(builder =&gt; {
            builder.AddServiceBusClientWithNamespace(FullyQualifiedNamespace);
        });
        var serviceProvider = services.BuildServiceProvider();
        var client = serviceProvider.GetRequiredService&lt;ServiceBusClient&gt;();
        var scenario = async () =&gt; await client.RunScenario(QueueName, nameof(Test_Scenario04_UseDependencyInjectionWithFullyQualifiedNamespace));
        await scenario();
    }
}
</code></pre>
<p>You might wonder why the <code>FullyQualifiedNamespace</code> one does not need credentials this time around. That's because the Azure SDK can take care of this by default. As mentioned in the previous section, <code>DefaultAzureCredential</code> is the easiest way to hit the ground running. There are two ways we can customize this behaviour. We can either provide a default credential for all Azure Clients or on a per-client basis.</p>
<pre><code class="language-csharp">public class UnitTest1
{
    private const string FullyQualifiedNamespace = &quot;&lt;your-namespace&gt;.servicebus.windows.net&quot;;
    private const string ConnectionString = &quot;&lt;your-connectionstring&gt;&quot;;
    private const string QueueName = &quot;demoqueue&quot;;

    [Fact]
    public async Task Test_Scenario05_DependencyInjectionChangeDefaultToken()
    {
        var services = new ServiceCollection();
        services.AddAzureClients(builder =&gt; {
            builder.AddServiceBusClientWithNamespace(FullyQualifiedNamespace);
            
            builder.UseCredential(new ManagedIdentityCredential());
        });
        var serviceProvider = services.BuildServiceProvider();
        var client = serviceProvider.GetRequiredService&lt;ServiceBusClient&gt;();
        var scenario = async () =&gt; await client.RunScenario(QueueName, nameof(Test_Scenario05_DependencyInjectionChangeDefaultToken));
        await scenario.Should().ThrowAsync&lt;CredentialUnavailableException&gt;();
    }

    [Fact]
    public async Task Test_Scenario06_DependencyInjectionChangeDefaultTokenOnClientLevel()
    {
        var services = new ServiceCollection();
        services.AddAzureClients(builder =&gt; {
            builder.AddServiceBusClientWithNamespace(FullyQualifiedNamespace)
                .WithCredential(new AzureCliCredential());
            
            builder.UseCredential(new ManagedIdentityCredential());
        });
        var serviceProvider = services.BuildServiceProvider();
        var client = serviceProvider.GetRequiredService&lt;ServiceBusClient&gt;();
        var scenario = async () =&gt; await client.RunScenario(QueueName, nameof(Test_Scenario06_DependencyInjectionChangeDefaultTokenOnClientLevel));
        await scenario();
    }
}
</code></pre>
<p>The first sample will not work since I have not set up ManagedIdentity in my environment. The second one also sets ManagedIdentityCredential as the default credential. However, since I set up AzureCliCredential on the client registration, it trumps the global one.</p>
<h2 id="can-we-have-different-client-config-when-using-the-azure-sdk"><a href="#can-we-have-different-client-config-when-using-the-azure-sdk">Can we have different client config when using the Azure SDK?</a></h2>
<p>Here is where things get cool. When you register a client with the SDK, a client named <code>Default</code> gets registered. If, for example, you retrieve <code>ServiceBusClient</code> from the dependency injection, what happens is that the AzureClientFactoy creates this client for you.</p>
<p>In the case of servicebus, you might have multiple different namespaces registered. Every registration provides access to a method <code>WithName</code>. To use named clients in your code, replace <code>ServiceBusClient</code> with <code>IAzureClientFactory&lt;ServiceBusClient</code>.</p>
<pre><code class="language-csharp">public class UnitTest1
{
    private const string FullyQualifiedNamespace = &quot;&lt;your-namespace&gt;.servicebus.windows.net&quot;;
    private const string ConnectionString = &quot;&lt;your-connectionstring&gt;&quot;;
    private const string QueueName = &quot;demoqueue&quot;;

    [Fact]
    public async Task Test_Scenario07_MultipleClients()
    {
        var services = new ServiceCollection();
        services.AddAzureClients(builder =&gt;
        {
            builder.AddServiceBusClient(ConnectionString);

            builder.AddServiceBusClientWithNamespace(FullyQualifiedNamespace)
                .WithName(&quot;OtherClient&quot;);
        });
        var serviceProvider = services.BuildServiceProvider();
        var clientFactory = serviceProvider.GetRequiredService&lt;IAzureClientFactory&lt;ServiceBusClient&gt;&gt;();
        
        var clientDefault = clientFactory.CreateClient(&quot;Default&quot;);
        var scenarioDefaultClient = async () =&gt; await clientDefault.RunScenario(QueueName, nameof(Test_Scenario07_MultipleClients) + &quot;A&quot;);
        await scenarioDefaultClient();
        
        var otherClient = clientFactory.CreateClient(&quot;OtherClient&quot;);
        var scenarioOtherClient = async () =&gt; await otherClient.RunScenario(QueueName, nameof(Test_Scenario07_MultipleClients) + &quot;B&quot;);
        await scenarioOtherClient();
    }
}
</code></pre>
<h2 id="can-i-use-configuration-to-create-azure-sdk-clients"><a href="#can-i-use-configuration-to-create-azure-sdk-clients">Can I use configuration to create Azure SDK clients?</a></h2>
<p>If I had one criticism of the SDK, it would be that the extension methods require the address right there in the call to the method. To be fair, there is an overload that uses IConfiguration, but that leaves everything up to the SDK to validate.</p>
<p>In my <a href="https://BaseUrl_1/2021/11/29/validated-strongly-typed-ioptions.html">previous article on validating IOptions</a>, I wrote about a way to make sure all configuration for my app is valid.</p>
<p>That approach, of course, requires access to the dependency injection container. Luckily there is an additional method available.</p>
<pre><code class="language-csharp">public class UnitTest1
{
    private const string FullyQualifiedNamespace = &quot;&lt;your-namespace&gt;.servicebus.windows.net&quot;;
    private const string QueueName = &quot;demoqueue&quot;;

    [Fact]
    public async Task Test_Scenario08_StronglyTypedOptions()
    {
        var services = new ServiceCollection();
        services.Configure&lt;DemoOptions&gt;(options =&gt;
        {
            options.ServiceBusNamespace = FullyQualifiedNamespace;
        });
        services.AddAzureClients(builder =&gt;
        {
            builder.AddClient&lt;ServiceBusClient, ServiceBusClientOptions&gt;((options, credential, provider) =&gt;
            {
                var demoOptions = provider.GetRequiredService&lt;IOptions&lt;DemoOptions&gt;&gt;();
                return new ServiceBusClient(demoOptions.Value.ServiceBusNamespace, credential, options);
            });
        });
        var serviceProvider = services.BuildServiceProvider();
        var client = serviceProvider.GetRequiredService&lt;ServiceBusClient&gt;();
        var scenario = async () =&gt; await client.RunScenario(QueueName, nameof(Test_Scenario08_StronglyTypedOptions));
        await scenario();
    }
}
</code></pre>
<h2 id="closing-thoughts"><a href="#closing-thoughts">Closing Thoughts</a></h2>
<p>A single blog is too short for providing an overview of everything the Azure SDK offers. I like that authentication and interoperability with the dependency injection container are baked into the SDK. I have not even touched on diagnostics and testability, which are both great topics built into the entire SDK. Who knows, perhaps that is a topic for another time.</p>
<p>As always, if you have any questions, feel free to reach out. Do you have suggestions or alternatives? I would love to hear about them.</p>
<p>The corresponding source code for this article is on <a href="https://github.com/kaylumah/WorkingWithAzureSdkForDotnet" class="external">GitHub</a>.</p>
<p>See you next time, stay healthy and happy coding to all 🧸!</p>
<h2 id="additional-resources"><a href="#additional-resources">Additional Resources</a></h2>
<ul>
<li><a href="https://docs.microsoft.com/en-us/dotnet/azure/sdk/azure-sdk-for-dotnet" class="external">Azure SDK for Dotnet on Microsoft Docs</a></li>
<li><a href="https://github.com/Azure/azure-sdk-for-net/blob/main/sdk/servicebus/Azure.Messaging.ServiceBus/README.md" class="external">Azure.Messaging.ServiceBus on GitHub</a></li>
<li><a href="https://github.com/Azure/azure-sdk-for-net/blob/main/sdk/core/Azure.Core/README.md" class="external">Azure.Core on GitHub</a></li>
<li><a href="https://github.com/Azure/azure-sdk-for-net/blob/main/sdk/identity/Azure.Identity/README.md" class="external">Azure.Identity on GitHub</a></li>
<li><a href="https://github.com/Azure/azure-sdk-for-net/blob/main/sdk/extensions/Microsoft.Extensions.Azure/README.md" class="external">Microsoft.Extensions.Azure on GitHub</a></li>
<li><a href="https://docs.microsoft.com/en-us/azure/service-bus-messaging" class="external">Service bus on Microsoft Docs</a></li>
<li><a href="https://devblogs.microsoft.com/azure-sdk/best-practices-for-using-azure-sdk-with-asp-net-core" class="external">Best practices Azure SDK</a></li>
<li><a href="https://docs.microsoft.com/en-gb/cli/azure/use-cli-effectively" class="external">Best practices Azure CLI</a></li>
</ul>
    </section>
    
        <section>
        <script src="https://giscus.app/client.js" data-repo="kaylumah/hosting" data-repo-id="MDEwOlJlcG9zaXRvcnkzMzgyNzg4MzU=" data-mapping="number" data-term="138" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light_high_contrast" data-lang="en" data-loading="lazy" crossorigin="anonymous" async>
        </script>    
        </section>
        
</article>

        </section>
    </main>
    <!-- Sidebar Widgets -->
    <aside class="lg:col-span-1 space-y-6">
        <!-- About me Widget -->
        <div class="bg-white rounded-2xl border border-gray-200 p-6">
            <div class="flex flex-col items-center gap-4">
                <img class="rounded-full h-32 w-32" src="https://BaseUrl_1/assets/avatar_background.svg" alt="Kaylumah Hero" />
                <h2 class="text-xl font-semibold">Max Hamulyák</h2>
                <span class="text-gray-600">aka Kaylumah</span>
            </div>
        </div>

        <!-- Sponsorship Widget -->
        <div class="bg-white rounded-2xl border border-gray-200 p-6">
            <h2 class="text-xl font-semibold mb-4">Sponsored</h2>
            <p class="text-gray-600 leading-relaxed">
                Enjoy reading my content? Consider becoming a sponsor for the blog.
                This will help keep the blog up and running!
            </p>
            <ul class="flex justify-center gap-4 mt-4">
                <li>
                    <a href="https://www.buymeacoffee.com/kaylumah" target="_blank" aria-label="Buy Me A Coffee">
                        <svg class="h-8 w-8" role="img" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none">
                            <title>Buy Me A Coffee</title>
                            <path fill="#FFDD00" d="M20.216 6.415l-.132-.666c-.119-.598-.388-1.163-1.001-1.379-.197-.069-.42-.098-.57-.241-.152-.143-.196-.366-.231-.572-.065-.378-.125-.756-.192-1.133-.057-.325-.102-.69-.25-.987-.195-.4-.597-.634-.996-.788a5.723 5.723 0 00-.626-.194c-1-.263-2.05-.36-3.077-.416a25.834 25.834 0 00-3.7.062c-.915.083-1.88.184-2.75.5-.318.116-.646.256-.888.501-.297.302-.393.77-.177 1.146.154.267.415.456.692.58.36.162.737.284 1.123.366 1.075.238 2.189.331 3.287.37 1.218.05 2.437.01 3.65-.118.299-.033.598-.073.896-.119.352-.054.578-.513.474-.834-.124-.383-.457-.531-.834-.473-.466.074-.96.108-1.382.146-1.177.08-2.358.082-3.536.006a22.228 22.228 0 01-1.157-.107c-.086-.01-.18-.025-.258-.036-.243-.036-.484-.08-.724-.13-.111-.027-.111-.185 0-.212h.005c.277-.06.557-.108.838-.147h.002c.131-.009.263-.032.394-.048a25.076 25.076 0 013.426-.12c.674.019 1.347.067 2.017.144l.228.031c.267.04.533.088.798.145.392.085.895.113 1.07.542.055.137.08.288.111.431l.319 1.484a.237.237 0 01-.199.284h-.003c-.037.006-.075.01-.112.015a36.704 36.704 0 01-4.743.295 37.059 37.059 0 01-4.699-.304c-.14-.017-.293-.042-.417-.06-.326-.048-.649-.108-.973-.161-.393-.065-.768-.032-1.123.161-.29.16-.527.404-.675.701-.154.316-.199.66-.267 1-.069.34-.176.707-.135 1.056.087.753.613 1.365 1.37 1.502a39.69 39.69 0 0011.343.376.483.483 0 01.535.53l-.071.697-1.018 9.907c-.041.41-.047.832-.125 1.237-.122.637-.553 1.028-1.182 1.171-.577.131-1.165.2-1.756.205-.656.004-1.31-.025-1.966-.022-.699.004-1.556-.06-2.095-.58-.475-.458-.54-1.174-.605-1.793l-.731-7.013-.322-3.094c-.037-.351-.286-.695-.678-.678-.336.015-.718.3-.678.679l.228 2.185.949 9.112c.147 1.344 1.174 2.068 2.446 2.272.742.12 1.503.144 2.257.156.966.016 1.942.053 2.892-.122 1.408-.258 2.465-1.198 2.616-2.657.34-3.332.683-6.663 1.024-9.995l.215-2.087a.484.484 0 01.39-.426c.402-.078.787-.212 1.074-.518.455-.488.546-1.124.385-1.766z"></path>
                        </svg>
                    </a>
                </li>
                <li>
                    <a href="https://github.com/sponsors/kaylumah" target="_blank" aria-label="GitHub Sponsors">
                        <svg class="h-8 w-8" role="img" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none">
                            <title>GitHub Sponsors</title>
                            <path fill="#EA4AAA" d="M17.625 1.499c-2.32 0-4.354 1.203-5.625 3.03-1.271-1.827-3.305-3.03-5.625-3.03C3.129 1.499 0 4.253 0 8.249c0 4.275 3.068 7.847 5.828 10.227a33.14 33.14 0 0 0 5.616 3.876l.028.017.008.003-.001.003c.163.085.342.126.521.125.179.001.358-.041.521-.125l-.001-.003.008-.003.028-.017a33.14 33.14 0 0 0 5.616-3.876C20.932 16.096 24 12.524 24 8.249c0-3.996-3.129-6.75-6.375-6.75zm-.919 15.275a30.766 30.766 0 0 1-4.703 3.316l-.004-.002-.004.002a30.955 30.955 0 0 1-4.703-3.316c-2.677-2.307-5.047-5.298-5.047-8.523 0-2.754 2.121-4.5 4.125-4.5 2.06 0 3.914 1.479 4.544 3.684.143.495.596.797 1.086.796.49.001.943-.302 1.085-.796.63-2.205 2.484-3.684 4.544-3.684 2.004 0 4.125 1.746 4.125 4.5 0 3.225-2.37 6.216-5.048 8.523z"></path>
                        </svg>
                    </a>
                </li>
            </ul>
        </div>

        <!-- Popular Widget -->
        <div class="bg-white rounded-2xl border border-gray-200 p-6">
            <h2 class="text-xl font-semibold mb-4">Popular posts</h2>
            <ul class="space-y-2">
                <li>
                    <a href="/2021/04/11/an-approach-to-writing-mocks.html" class="hover:text-blue-600">
                        Experiment with Moq, an approach to writing mocks
                    </a>
                </li>
                <li>
                    <a href="/2019/09/07/using-csharp-code-your-git-hooks.html" class="hover:text-blue-600">
                        Using C# code in your git hooks
                    </a>
                </li>
            </ul>
        </div>
        
        <!-- TagCloud Widget -->
        <div class="bg-white rounded-2xl border border-gray-200 p-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">Tags</h2>
            <ul id="word-cloud" class="flex justify-center flex-wrap align-center gap-1.5 leading-7">
            </ul>
        </div>

        <script>
            const words = [
  {
    "Id": "azure",
    "DisplayName": "Azure",
    "Description": "Microsoft Azure Platform",
    "Size": 2
  },
  {
    "Id": "code-quality",
    "DisplayName": "Code Quality",
    "Description": "Code Quality",
    "Size": 1
  },
  {
    "Id": "configuration",
    "DisplayName": "Configuration",
    "Description": "Application configuration",
    "Size": 1
  },
  {
    "Id": "csharp",
    "DisplayName": "C#",
    "Description": "for the C# programming language",
    "Size": 9
  },
  {
    "Id": "git",
    "DisplayName": "Git",
    "Description": "for the Git version control system",
    "Size": 1
  },
  {
    "Id": "markdown",
    "DisplayName": "Markdown",
    "Description": "for the Markdown language",
    "Size": 1
  },
  {
    "Id": "moq",
    "DisplayName": "Moq",
    "Description": "for the Moq mocking library in .NET",
    "Size": 1
  },
  {
    "Id": "msbuild",
    "DisplayName": "MSBuild",
    "Description": "for the Microsoft Build Engine",
    "Size": 2
  },
  {
    "Id": "nswag",
    "DisplayName": "NSwag",
    "Description": "for the NSwag swagger tooling in .NET",
    "Size": 2
  },
  {
    "Id": "nuget",
    "DisplayName": "NuGet",
    "Description": "for the .NET package manager",
    "Size": 1
  },
  {
    "Id": "openapi",
    "DisplayName": "OpenAPI",
    "Description": "for the OpenAPI Specification (formerly Swagger Specification)",
    "Size": 2
  },
  {
    "Id": "reqnroll",
    "DisplayName": "Reqnroll",
    "Description": "Cucumber runner for .NET",
    "Size": 1
  },
  {
    "Id": "rider",
    "DisplayName": "Rider",
    "Description": "for the JetBrains Rider IDE",
    "Size": 1
  },
  {
    "Id": "swashbuckle",
    "DisplayName": "Swashbuckle",
    "Description": "for the Swashbuckle swagger tooling in .NET",
    "Size": 2
  },
  {
    "Id": "testing",
    "DisplayName": "Testing",
    "Description": "for test related matters",
    "Size": 4
  },
  {
    "Id": "visualstudio",
    "DisplayName": "Visual Studio",
    "Description": "for the Microsoft Visual Studio IDE",
    "Size": 1
  },
  {
    "Id": "visualstudio2019",
    "DisplayName": "Visual Studio 2019",
    "Description": "for the Microsoft Visual Studio IDE",
    "Size": 1
  },
  {
    "Id": "vscode",
    "DisplayName": "VS Code",
    "Description": "for the Microsoft VS Code IDE",
    "Size": 2
  },
  {
    "Id": "xunit",
    "DisplayName": "Xunit",
    "Description": "for the Xunit test framework",
    "Size": 2
  }
];

            const container = document.getElementById('word-cloud');

            words.forEach(word => {
                const li = document.createElement('li');
                const anchor = document.createElement('a');
                anchor.href = `/blog.html?tag=${word.Id}`;
                anchor.title = word.Description;
                anchor.textContent = `${word.DisplayName} (${word.Size})`;
                anchor.classList.add("inline-flex", "hover:underline", "transition");

                // Apply font sizes based on word frequency
                const x = word.Size;
                switch (true) {
                    case (x < 2):
                        anchor.classList.add("text-sm", "text-gray-600", "opacity-80");
                        break;
                    case (x < 4):
                        anchor.classList.add("text-base", "font-medium", "text-gray-700");
                        break;
                    case (x < 6):
                        anchor.classList.add("text-lg", "font-semibold", "text-gray-800");
                        break;
                    default:
                        anchor.classList.add("text-2xl", "font-bold", "text-gray-900");
                        break;
                }

                li.appendChild(anchor);
                container.appendChild(li);
            });
        </script>
        
    </aside>
</div>
</div>
<footer class="bg-white border-t border-gray-200 py-6 text-center text-gray-500 text-sm">
    © Kaylumah. All rights reserved.
</footer>
<div id="cookie-banner" class="fixed inset-x-0 bottom-0 z-50 bg-white shadow-md border-t border-gray-200 p-4 tablet:p-6 flex flex-col tablet:flex-row items-center justify-between gap-4">
    <p class="text-sm text-gray-900 leading-6">
        This website uses cookies to enhance your browsing experience, analyze site traffic, and serve better user experiences. By continuing to use this site, you consent to our use of cookies.
        Learn more in our
        <a class="font-semibold text-primary hover:underline" href="/privacy">cookie policy</a>.
    </p>
    <div class="flex items-center gap-4">
        <button onclick="handleCookieConsentGranted()" type="button" class="rounded-md bg-gray-900 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-gray-700">
            Accept all
        </button>
        <button onclick="handleCookieConsentDenied()" type="button" class="text-sm font-semibold text-gray-900 hover:text-gray-700">
            Reject all
        </button>
    </div>
</div>

<script>
    window.hideCookieBanner = function() {
        let cookieBanner = document.getElementById("cookie-banner");
        if (cookieBanner) {
            cookieBanner.classList.add("hidden");
        }
    };

    window.handleCookieConsentGranted = function() {
        window.setCookieConsent("granted");
        window.setGtagConsentStatus("update", "granted");
        window.hideCookieBanner();
    };

    window.handleCookieConsentDenied = function() {
        window.setCookieConsent("denied");
        window.setGtagConsentStatus("update", "denied");
        window.hideCookieBanner();
    };

    // Check if consent has already been given
    if (window.getCookieConsent() !== "unknown") {
        window.hideCookieBanner();
    }
</script>

</body>
</html>